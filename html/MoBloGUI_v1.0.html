<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>MoBlo</title>

    <style>
        body {
            margin: 5;
            overflow-x: hidden;
            overflow-y: scroll;
            background-color: rgb(0, 102, 160);
        }
        canvas {
            overflow-x: hidden;
            overflow-y: scroll;
            background-color: rgb(250, 250, 250);
            border:1px solid #000000;
        }


        /* Style the tab */
        .tab {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
        }

        /* Style the buttons that are used to open the tab content */
        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
        }

        /* Change background color of buttons on hover */
        .tab button:hover {
            background-color: #ddd;
        }

        /* Create an active/current tablink class */
        .tab button.active {
            background-color: #ccc;
        }

        /* Style the tab content */
        .tabcontent {
            display: none;
            padding: 6px 12px;
            border: 1px solid #ccc;
            border-top: none;
        } 

    </style>

  </head>
  <body>

    <div style="padding:3px; border-top:5px dashed #fff; border-bottom:5px dashed #fff; background-color:#e3e3e3;">
        <h3>Project Definition</h3>
        Project name: <input type="text" id="project_name"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Designer name: <input type="text" id="designer_name">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<button onclick="initNames()">Give Project Names</button>
        <br />
        <br />
    </div>
    <br />

     <!-- Tab links -->
    <div class="tab">
      <button class="tablinks" onclick="openDiagramme(event, 'PopulationMap')">Population Map</button>
      <button class="tablinks" onclick="openDiagramme(event, 'UnitDefinition')">Unit Definition</button>
      <button class="tablinks" onclick="openDiagramme(event, 'BusinessTransactions')">Business Transactions</button>
      <button class="tablinks" onclick="openDiagramme(event, 'StreamDefinition')">Stream Definition</button>
      <button class="tablinks" onclick="openDiagramme(event, 'StreamPublication')">Stream Publication</button>
    </div>

    <!-- Tab content -->
    <div id="PopulationMap" class="tabcontent">
        <div style="padding:3px; border-top:5px dashed #fff; border-bottom:5px dashed #fff; background-color:#e3e3e3;">
            <h4>Population Map</h4>
            <table>
                <tr>
                    <td valign="top">
                        Node: <input type="text" id="nodename" maxlength="5"> <button onclick="addPopulationMapNode()">---></button><select id="listNodeName"></select>
                    </td>
                    <td valign="top">
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    </td>
                    <td valign="top">
                        <input type="checkbox" id="connectRight"><label for="connectRight">Connect</label>
                        <br />
                        <input type="checkbox" id="sendRight"><label for="sendRight">Send</label> <input type="checkbox" id="receiveRight"><label for="receiveRight">Receive</label> 
                        <br />
                        <input type="checkbox" id="issueRight"><label for="issueRight">Issue</label> <input type="checkbox" id="createRight"><label for="createRight">Create</label> 
                        <br />
                        <input type="checkbox" id="processRight"><label for="processRight">Process</label> <input type="checkbox" id="activateRight"><label for="activateRight">Activate</label> 
                        <input type="checkbox" id="adminRight"><label for="adminRight">Admin</label> <input type="checkbox" id="originRight"><label for="originRight">Origin Node</label> 
                        <br />
                    </td>
                    <td valign="top">
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    </td>
                    <td valign="bottom">
                        <button onclick="addPopulationMapAddress()">Add Address</button>
                    </td>
                </tr>
            </table>

            <br />
            <br />
        </div>
        <br />

        <canvas class="mobloPopulationMap">
          <p>Your browser cannot be used.</p>
        </canvas>
    </div>

    <div id="UnitDefinition" class="tabcontent">
        <div style="padding:3px; border-top:5px dashed #fff; border-bottom:5px dashed #fff; background-color:#e3e3e3;">
            <h4>Unit Definition</h4>
            <table>
                <tr>
                    <td valign="top">
                        <select id="listNodeIssueName"></select>
                    </td>
                    <td valign="top">
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    </td>
                    <td valign="top">
                        Unit Name &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="text" id="unitname">
                        <br />
                        Unit Quantity &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="text" id="unitquantity">
                        <br />
                        Opened &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="radio" name="unitopened" value="true" id="unitopenedTrue" checked="checked"> True &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="radio" name="unitopened" value="false" id="unitopenedFalse"> False
                        <br />
                    </td>
                    <td valign="top">
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    </td>
                    <td valign="bottom">
                        <button onclick="addUnitDefinition()">Add Unit</button>
                    </td>
                </tr>
            </table>

            <br />
            <br />
        </div>
        <br />

        <canvas class="mobloUnitDefinition">
          <p>Your browser cannot be used.</p>
        </canvas>
    </div>

    <div id="BusinessTransactions" class="tabcontent">
        <div style="padding:3px; border-top:5px dashed #fff; border-bottom:5px dashed #fff; background-color:#e3e3e3;">
            <h4>Business Transactions</h4>
            <table>
                <tr>
                    <td valign="top">
                        Action Name : <input type="text" id="actionname">
                    </td>
                    <td valign="top">
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    </td>
                    <td valign="top">
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    </td>
                    <td valign="top">
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    </td>
                    <td valign="top">
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    </td>
                </tr>
                <tr>
                    <td valign="top">
                        Origin : &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<select id="listOriginNodeName"></select>
                    </td>
                    <td valign="top">
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    </td>
                    <td valign="top">
                        Destination : &nbsp;&nbsp;&nbsp;<select id="listDestinationNodeName"></select>
                    </td>
                    <td valign="top">
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    </td>
                    <td valign="top">
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    </td>
                </tr>
                <tr>
                    <td valign="top">
                        Unit : &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<select id="listAssetName"></select>
                    </td>
                    <td valign="top">
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    </td>
                    <td valign="top">
                        Quantity : &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="text" id="assetvalue">
                    </td>
                    <td valign="top">
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    </td>
                    <td valign="top">
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    </td>
                </tr>
                <tr>
                    <td valign="top" colspan="3">
                        Data : &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="text" id="transactiondata" size="65">
                    </td>
                    <td valign="top">
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    </td>
                    <td valign="top">
                        <button onclick="addBusinessTransaction()">Add transaction</button>
                    </td>
                </tr>
            </table>

            <br />
            <br />
        </div>
        <br />

        <canvas class="mobloBusinessTransactions">
          <p>Your browser cannot be used.</p>
        </canvas>
    </div>

    <div id="StreamDefinition" class="tabcontent">
        <div style="padding:3px; border-top:5px dashed #fff; border-bottom:5px dashed #fff; background-color:#e3e3e3;">
            <h4>Stream Definition</h4>
            <table>
                <tr>
                    <td valign="top">
                        <select id="listNodeStreamName"></select>
                    </td>
                    <td valign="top">
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    </td>
                    <td valign="top">
                        Stream Name &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="text" id="streamname">
                        <br />
                        Opened &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="radio" checked name="streamopened" value="true" id="streamopenedTrue"> True &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="radio" name="streamopened" value="false" id="streamopenedFalse"> False
                        <br />
                    </td>
                    <td valign="top">
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    </td>
                    <td valign="bottom">
                        <button onclick="addStreamDefinition()">Add Stream</button>
                    </td>
                </tr>
            </table>

            <br />
            <br />
        </div>
        <br />

        <canvas class="mobloStreamDefinition">
          <p>Your browser cannot be used.</p>
        </canvas>
    </div>

    <div id="StreamPublication" class="tabcontent">
        <div style="padding:3px; border-top:5px dashed #fff; border-bottom:5px dashed #fff; background-color:#e3e3e3;">
            <h4>Stream Publication</h4>
            <table>
                <tr>
                    <td valign="top">
                        <select id="listStreamName" onchange="loadStreamNodes()"></select>
                    </td>
                    <td valign="top">
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    </td>
                    <td valign="top">
                        <select id="listNodeStreamPublicationName"></select>
                        <br />
                        Name : &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="text" id="streampulicationname">
                        <br />
                        Key : &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="text" id="streamkey">
                        <br />
                        Value : &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="text" id="streamvalue" size="90">
                        <br />
                    </td>
                    <td valign="top">
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    </td>
                    <td valign="bottom">
                        <button onclick="addStreamPublication()">Publish in Stream</button>
                    </td>
                </tr>
            </table>

            <br />
            <br />
        </div>
        <br />

        <canvas class="mobloStreamPublication">
          <p>Your browser cannot be used.</p>
        </canvas>
    </div>




    <script>
        function openDiagramme(evt, diagrammeName) {
          // Declare all variables
          var i, tabcontent, tablinks;

          // Get all elements with class="tabcontent" and hide them
          tabcontent = document.getElementsByClassName("tabcontent");
          for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
          }

          // Get all elements with class="tablinks" and remove the class "active"
          tablinks = document.getElementsByClassName("tablinks");
          for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
          }

          // Show the current tab, and add an "active" class to the button that opened the tab
          document.getElementById(diagrammeName).style.display = "block";
          evt.currentTarget.className += " active";

            if (diagrammeName == 'StreamPublication') {
                loadStreamNodes();
            }
        } 
    
        var MoBlo_Nodelist = [];
        var MoBlo_AddressMap = {};
        var MoBlo_UnitDefinitionList = [];
        var MoBlo_ActionNameList = [];
        var MoBlo_TransactionDefinitionList = [];
        var MoBlo_StreamDefinitionList = [];
        var MoBlo_PublicationDefinitionList = [];

        var canvas_PM = document.querySelector('.mobloPopulationMap');
        var ctx_PM = canvas_PM.getContext('2d');

        initMobloZone('.mobloPopulationMap', 'Population Map', ctx_PM);

        var canvas_UD = document.querySelector('.mobloUnitDefinition');
        var ctx_UD = canvas_UD.getContext('2d');

        initMobloZone('.mobloUnitDefinition', 'Unit Definition', ctx_UD);

        var canvas_BT = document.querySelector('.mobloBusinessTransactions');
        var ctx_BT = canvas_BT.getContext('2d');

        initMobloZone('.mobloBusinessTransactions', 'Business Transactions', ctx_BT);

        var canvas_SD = document.querySelector('.mobloStreamDefinition');
        var ctx_SD = canvas_SD.getContext('2d');

        initMobloZone('.mobloStreamDefinition', 'Stream Definition', ctx_SD);

        var canvas_SP = document.querySelector('.mobloStreamPublication');
        var ctx_SP = canvas_SP.getContext('2d');

        initMobloZone('.mobloStreamPublication', 'Stream Publication', ctx_SP);


        function initNames() {
            var projectName = document.getElementById("project_name").value;
            var designerName = document.getElementById("designer_name").value;
            if (designerName == null) { designerName = ""; }
            if  (projectName != null) {
                deleteMoBloProjectNames(ctx_PM);
                deleteMoBloProjectNames(ctx_UD);
                deleteMoBloProjectNames(ctx_SD);
                drawMoBloProjectNames(ctx_PM, projectName, designerName);
                drawMoBloProjectNames(ctx_UD, projectName, designerName);
                drawMoBloProjectNames(ctx_SD, projectName, designerName);
            }
        }

        function getFormatedDate() {
            var d = new Date();
            return d.getFullYear() + " / " + (1+d.getMonth()) + " / " + d.getDate();
        }

        function initMobloZone(canvasname, zonename, ctx) {
            var canvas = document.querySelector(canvasname);
            canvas.width = 1020;
            canvas.height = 160;

            drawMoBloZone(ctx, 5, 5);

            ctx.fillStyle = 'rgb(0, 102, 160)';
            ctx.font = '18px serif';
            ctx.fillText('MoBlo - ' + zonename, 15, 25);

            ctx.font = 'italic 16px serif';
            ctx.fillText("Project :  ", 15, 85);
            ctx.fillText("Designer : ", 15, 105);

            ctx.font = '16px serif';
            ctx.fillStyle = 'rgb(0, 0, 0)';
            ctx.fillText(getFormatedDate(), 105, 55);

            ctx.fillStyle = 'rgb(125, 125, 125)';
            ctx.font = 'italic 14px serif';
            ctx.fillText('MoBlo GUI v1.0', 900, 25);

        }

        function drawMoBloZone(ctx, x, y) {
            ctx.lineWidth = 4;
            ctx.fillStyle = 'rgb(255, 255, 255)';
            ctx.fillRect(x, y, 500, 150);
            ctx.strokeStyle = 'rgb(0, 102, 160)';
            ctx.strokeRect(x, y, 500, 150);
        }

        function drawMoBloDoubleZone(ctx, y) {
            ctx.lineWidth = 4;
            ctx.fillStyle = 'rgb(255, 255, 255)';
            ctx.fillRect(5, y, 1010, 150);
            ctx.strokeStyle = 'rgb(0, 102, 160)';
            ctx.strokeRect(5, y, 1010, 150);
        }

        function drawMoBloDoubleOpenedZone(ctx, y, nb) {
            ctx.beginPath();
            ctx.lineWidth = 4;
            ctx.strokeStyle = 'rgb(0, 102, 160)';
            if (nb > 1) {
                ctx.moveTo(5, y + 2);
                ctx.lineTo(1010, y + 2 );
            }
            ctx.moveTo(5, y + 12);
            ctx.lineTo(1010, y + 12);
            ctx.stroke();
        }



        function drawMoBloProjectNames(ctx, projectName, designerName) {
            ctx.font = '16px serif';
            ctx.fillStyle = 'rgb(0, 0, 0)';
            ctx.fillText(projectName, 105, 85);
            ctx.fillText(designerName, 105, 105);
        }

        function deleteMoBloProjectNames(ctx) {
            ctx.fillStyle = 'rgb(255, 255, 255)';
            ctx.fillRect(99, 77, 300, 40);
        }

        function calculateMoBloCorner(index) {
            var column = (index-1) % 2;
            var line = 1 + Math.trunc((index-1)/2);
            var coord = [column, line, 5 + column * 510, 5 + line * 160];
            return coord;
        }


        function writePopulationMapName(zoneName, x, y) {
            ctx_PM.fillStyle = 'rgb(0, 102, 160)';
            ctx_PM.font = '18px serif';
            ctx_PM.fillText(zoneName, x, y);
        }

        function addPopulationMapNode() {
            var nodename = document.getElementById("nodename").value;
            if(nodename != null) {
                MoBlo_Nodelist.push(nodename);
                //addnode in html list
                var listNodeName = document.getElementById("listNodeName");
                var option = document.createElement("option");
                option.text = nodename;
                listNodeName.add(option);
                listNodeName.selectedIndex = listNodeName.length-1;
                var listOriginNodeName = document.getElementById("listOriginNodeName");
                var optionOrigin = document.createElement("option");
                optionOrigin.text = nodename;
                listOriginNodeName.add(optionOrigin);
                var listDestinationNodeName = document.getElementById("listDestinationNodeName");
                var optionDestination = document.createElement("option");
                optionDestination.text = nodename;
                listDestinationNodeName.add(optionDestination);
                document.getElementById("nodename").value = '';
                //add graphic zone
                var coord = calculateMoBloCorner(MoBlo_Nodelist.length);

                if (coord[0] == 0 ) {
                    var canvas_PM = document.querySelector('.mobloPopulationMap');
                    var height = canvas_PM.height;
                    var imgData=ctx_PM.getImageData(0,0,canvas_PM.width,canvas_PM.height);
                    canvas_PM.height = height + 160;
                    ctx_PM.putImageData(imgData,0,0);
                } 
                drawMoBloZone(ctx_PM, coord[2], coord[3]);
                writePopulationMapName(nodename, 5 + coord[0] * 505 + 10, 5 + coord[1] * 160 + 20);
            }
        }

        function drawSimpleNode(x, y, radius) {
            ctx_PM.beginPath();
            ctx_PM.strokeStyle = 'rgb(0, 0, 0)';
            ctx_PM.lineWidth = 4;
            ctx_PM.arc(x,y,radius,0,2*Math.PI);
            ctx_PM.stroke();
        }


        function drawConnectNode(x, y, radius) {
            ctx_PM.beginPath();
            ctx_PM.strokeStyle = 'rgb(0, 0, 0)';
            ctx_PM.lineWidth = 4;
            ctx_PM.arc(x,y,radius,0,2*Math.PI);
            ctx_PM.stroke();

            ctx_PM.beginPath();
            ctx_PM.fillStyle = 'rgb(255, 255, 255)';
            ctx_PM.lineWidth = 8;
            ctx_PM.arc(x,y+radius,radius*0.4,0,2*Math.PI);
            ctx_PM.fill();

            ctx_PM.beginPath();
            ctx_PM.strokeStyle = 'rgb(0, 0, 0)';
            ctx_PM.lineWidth = 4;
            ctx_PM.arc(x,y+radius,radius*0.4,0,2*Math.PI);
            ctx_PM.stroke();

        }


        function drawBizNode(rights, x, y, radius) {
            ctx_PM.beginPath();
            ctx_PM.strokeStyle = 'rgb(0, 0, 0)';
            ctx_PM.lineWidth = 4;
            ctx_PM.arc(x,y,radius,0,2*Math.PI);
            ctx_PM.stroke();

            //send
            if(rights[1]) {
                ctx_PM.beginPath();
                ctx_PM.lineWidth = 8;
                ctx_PM.strokeStyle = 'rgb(255, 255, 255)';
                ctx_PM.moveTo(x-radius,     y+radius*0.1+radius);
                ctx_PM.lineTo(x-radius*0.4, y+radius*0.1+radius*0.4);
                ctx_PM.moveTo(x-radius*0.4, y+radius*0.1+radius);
                ctx_PM.lineTo(x-radius,     y+radius*0.1+radius*0.4);
                ctx_PM.stroke();
                ctx_PM.beginPath();
                ctx_PM.lineWidth = 4;
                ctx_PM.strokeStyle = 'rgb(0, 0, 0)';
                ctx_PM.moveTo(x-radius,     y+radius*0.1+radius);
                ctx_PM.lineTo(x-radius*0.4, y+radius*0.1+radius*0.4);
                ctx_PM.moveTo(x-radius*0.4, y+radius*0.1+radius);
                ctx_PM.lineTo(x-radius,     y+radius*0.1+radius*0.4);
                ctx_PM.stroke();
            }

            //receive
            if(rights[2]) {
                ctx_PM.lineWidth = 8;
                ctx_PM.strokeStyle = 'rgb(255, 255, 255)';
                ctx_PM.strokeRect(x+radius,     y+radius*0.1+radius, -radius*0.6, -radius*0.6);
                ctx_PM.lineWidth = 4;
                ctx_PM.strokeStyle = 'rgb(0, 0, 0)';
                ctx_PM.strokeRect(x+radius,     y+radius*0.1+radius, -radius*0.6, -radius*0.6);
            }


            //issue
            if(rights[3]) {
                ctx_PM.beginPath();
                ctx_PM.lineWidth = 8;
                ctx_PM.strokeStyle = 'rgb(255, 255, 255)';
                ctx_PM.moveTo(x+radius,     y-radius*0.1-radius*0.4);
                ctx_PM.lineTo(x+radius*0.4, y-radius*0.1-radius*0.4);
                ctx_PM.lineTo(x+radius*0.7, y-radius*0.1-radius);
                ctx_PM.lineTo(x+radius,     y-radius*0.1-radius*0.4);
                ctx_PM.stroke();
                ctx_PM.beginPath();
                ctx_PM.lineWidth = 4;
                ctx_PM.strokeStyle = 'rgb(0, 0, 0)';
                ctx_PM.moveTo(x+radius,     y-radius*0.1-radius*0.4);
                ctx_PM.lineTo(x+radius*0.4, y-radius*0.1-radius*0.4);
                ctx_PM.lineTo(x+radius*0.7, y-radius*0.1-radius);
                ctx_PM.lineTo(x+radius,     y-radius*0.1-radius*0.4);
                ctx_PM.stroke();
            }

            //create
            if(rights[4]) {
                ctx_PM.beginPath();
                ctx_PM.lineWidth = 8;
                ctx_PM.strokeStyle = 'rgb(255, 255, 255)';
                ctx_PM.moveTo(x-0.83*radius,     y-radius*0.08-radius);
                ctx_PM.lineTo(x-0.6*radius*0.4, y-radius*0.15-radius*0.4);
                ctx_PM.moveTo(x-radius,     y-0.9*radius);
                ctx_PM.lineTo(x-radius*0.4, y-0.9*radius*0.4);
                ctx_PM.stroke();
                ctx_PM.beginPath();
                ctx_PM.lineWidth = 4;
                ctx_PM.strokeStyle = 'rgb(0, 0, 0)';
                ctx_PM.moveTo(x-0.83*radius,     y-radius*0.08-radius);
                ctx_PM.lineTo(x-0.6*radius*0.4, y-radius*0.15-radius*0.4);
                ctx_PM.moveTo(x-radius,     y-0.9*radius);
                ctx_PM.lineTo(x-radius*0.4, y-0.9*radius*0.4);
                ctx_PM.stroke();
            }

        }

        function drawAdminNode(rights, x, y, radius) {
            ctx_PM.beginPath();
            ctx_PM.strokeStyle = 'rgb(0, 0, 0)';
            ctx_PM.lineWidth = 4;
            ctx_PM.arc(x,y,radius,0,2*Math.PI);
            ctx_PM.stroke();

            //admin
            if(rights[1] || rights[2]) {
                ctx_PM.beginPath();
                ctx_PM.strokeStyle = 'rgb(0, 0, 0)';
                ctx_PM.lineWidth = 4;
                ctx_PM.arc(x,y,radius*0.8,0,2*Math.PI);
                ctx_PM.stroke();
            }

            //mine
            if(rights[4]) {
                ctx_PM.beginPath();
                ctx_PM.fillStyle = 'rgb(0, 0, 0)';
                ctx_PM.lineWidth = 4;
                ctx_PM.arc(x,y,radius*0.4,0,2*Math.PI);
                ctx_PM.fill();
            }

            //activate            
            if(rights[1] || rights[3]) {
                ctx_PM.beginPath();
                ctx_PM.lineWidth = 8;
                ctx_PM.strokeStyle = 'rgb(255, 255, 255)';
                ctx_PM.moveTo(x-radius,     y-radius);
                ctx_PM.lineTo(x-radius*0.4, y-radius*0.4);
                ctx_PM.stroke();
                ctx_PM.beginPath();
                ctx_PM.lineWidth = 4;
                ctx_PM.strokeStyle = 'rgb(0, 0, 0)';
                ctx_PM.moveTo(x-radius,     y-radius);
                ctx_PM.lineTo(x-radius*0.4, y-radius*0.4);
                ctx_PM.stroke();
            }

        }

        function addPopulationMapAddress() {
            var selectedIndex = document.getElementById("listNodeName").selectedIndex;
            var nodename = document.getElementById("listNodeName").options[selectedIndex].value;

            if (nodename != null && nodename != "") {
                var connectRight = document.getElementById('connectRight').checked;
                var sendRight = document.getElementById('sendRight').checked;
                var receiveRight = document.getElementById('receiveRight').checked;
                var issueRight = document.getElementById('issueRight').checked;
                var createRight = document.getElementById('createRight').checked;
                var processRight = document.getElementById('processRight').checked;
                var activateRight = document.getElementById('activateRight').checked;
                var adminRight = document.getElementById('adminRight').checked;
                var originRight = document.getElementById('originRight').checked;

                if (originRight || adminRight || activateRight || processRight) {

                    var rights = ['admin', originRight, adminRight, activateRight, processRight];
                    if (MoBlo_AddressMap[nodename] == null ) {
                        var r_rights = [rights];
                        MoBlo_AddressMap[nodename] = r_rights;
                    } else {
                        var r_rights = MoBlo_AddressMap[nodename];
                        r_rights.push(rights);
                        MoBlo_AddressMap[nodename] = r_rights;
                    }

                    if (MoBlo_Nodelist != null) {
                        var nodeindex = MoBlo_Nodelist.indexOf(nodename);
                        
                        var coord = calculateMoBloCorner(nodeindex+1);
                        var radius = 30;
                        var x = coord[2] + radius + 20;
                        var y = coord[3] + radius + 50;

                        x = x + ((MoBlo_AddressMap[nodename].length -1) * (2*radius + 10));

                        drawAdminNode(rights, x, y, radius);
                    }
                }

                if (sendRight || receiveRight || issueRight || createRight) {

                    var rights = ['user', sendRight, receiveRight, issueRight, createRight];
                    if (MoBlo_AddressMap[nodename] == null ) {
                        var r_rights = [rights];
                        MoBlo_AddressMap[nodename] = r_rights;
                    } else {
                        var r_rights = MoBlo_AddressMap[nodename];
                        r_rights.push(rights);
                        MoBlo_AddressMap[nodename] = r_rights;
                    }

                    if (MoBlo_Nodelist != null) {
                        var nodeindex = MoBlo_Nodelist.indexOf(nodename);
                        
                        var coord = calculateMoBloCorner(nodeindex+1);
                        var radius = 30;
                        var x = coord[2] + radius + 20;
                        var y = coord[3] + radius + 50;

                        x = x + ((MoBlo_AddressMap[nodename].length -1) * (2*radius + 10));

                        drawBizNode(rights, x, y, radius);
                    }
                }

                if (issueRight) {

                    var listNodeIssueName = document.getElementById("listNodeIssueName");
                    var option = document.createElement("option");
                    option.text = nodename;
                    listNodeIssueName.add(option);

                }

                if (createRight) {

                    var listNodeStreamName = document.getElementById("listNodeStreamName");
                    var option = document.createElement("option");
                    option.text = nodename;
                    listNodeStreamName.add(option);
                }


                if (connectRight) {

                    var rights = ['control', connectRight];
                    if (MoBlo_AddressMap[nodename] == null ) {
                        var r_rights = [rights];
                        MoBlo_AddressMap[nodename] = r_rights;
                    } else {
                        var r_rights = MoBlo_AddressMap[nodename];
                        r_rights.push(rights);
                        MoBlo_AddressMap[nodename] = r_rights;
                    }

                    if (MoBlo_Nodelist != null) {
                        var nodeindex = MoBlo_Nodelist.indexOf(nodename);
                        
                        var coord = calculateMoBloCorner(nodeindex+1);
                        var radius = 30;
                        var x = coord[2] + radius + 20;
                        var y = coord[3] + radius + 50;

                        x = x + ((MoBlo_AddressMap[nodename].length -1) * (2*radius + 10));

                        drawConnectNode(x, y, radius);
                    }
                }
            }

        }

        function drawUnitDefinition(unitdefinition, x, y) {
            //Node name
            ctx_UD.fillStyle = 'rgb(0, 102, 160)';
            ctx_UD.font = '18px serif';
            ctx_UD.fillText("owner : " + unitdefinition[0], x + 10, y + 20);

            //Unit
            var radius = 60;
            ctx_UD.beginPath();
            ctx_UD.lineWidth = 4;
            ctx_UD.strokeStyle = 'rgb(0, 0, 0)';
            ctx_UD.moveTo(x + 75 + radius,     y + 50 + radius);
            ctx_UD.lineTo(x + 75,              y + 50 + radius);
            ctx_UD.lineTo(x + 75 + radius*0.5, y + 50);
            if (!unitdefinition[2]) {
                ctx_UD.lineTo(x + 75 + radius,     y + 50 + radius);
            }
            ctx_UD.stroke();

            //Unit name
            ctx_UD.fillStyle = 'rgb(0, 0, 0)';
            ctx_UD.font = '18px serif';
            ctx_UD.fillText(unitdefinition[1], x + 200, y + 80);

            //Unit quantity
            ctx_UD.fillStyle = 'rgb(0, 0, 0)';
            ctx_UD.font = 'italic 14px serif';
            ctx_UD.fillText(unitdefinition[3], x + 65, y + 130);
        }

        function addUnitDefinition() {
            var selectedIndex = document.getElementById("listNodeIssueName").selectedIndex;
            var nodename = document.getElementById("listNodeIssueName").options[selectedIndex].value;
            var unitname = document.getElementById("unitname").value;
            var unitquantity = document.getElementById("unitquantity").value;

            if (nodename != null && nodename != "" && unitname != null && unitname != "") {
                var unitopenedTrue = document.getElementById('unitopenedTrue').checked;
                var unitdefinition = [nodename, unitname, unitopenedTrue, unitquantity];
                MoBlo_UnitDefinitionList.push(unitdefinition);

                var listAssetName = document.getElementById("listAssetName");
                var optionAsset = document.createElement("option");
                optionAsset.text = unitname;
                listAssetName.add(optionAsset);

                //add graphic zone
                var coord = calculateMoBloCorner(MoBlo_UnitDefinitionList.length);

                if (coord[0] == 0 ) {
                    var canvas_UD = document.querySelector('.mobloUnitDefinition');
                    var height = canvas_UD.height;
                    var imgData=ctx_UD.getImageData(0,0,canvas_UD.width,canvas_UD.height);
                    canvas_UD.height = height + 160;
                    ctx_UD.putImageData(imgData,0,0);
                } 
                drawMoBloZone(ctx_UD, coord[2], coord[3]);
                drawUnitDefinition(unitdefinition, coord[2], coord[3]);

            }
        }

        function drawStreamDefinition(streamdefinition, x, y) {
            //Node name
            ctx_SD.fillStyle = 'rgb(0, 102, 160)';
            ctx_SD.font = '18px serif';
            ctx_SD.fillText("owner : " + streamdefinition[0], x + 10, y + 20);

            //Stream
            var radius = 60;
            ctx_SD.lineWidth = 4;
            if (streamdefinition[2]) {
                ctx_SD.setLineDash([10, 10]);
            }
            ctx_SD.strokeStyle = 'rgb(0, 0, 0)';
            ctx_SD.strokeRect(x + 45,     y + 50, 2 * radius, radius);
            ctx_SD.setLineDash([1, 0]);
            if (!streamdefinition[2]) {
                ctx_SD.strokeRect(x + 50,     y + 55, (2 * radius) - 10, radius -10);
            }

            //Stream name
            ctx_SD.fillStyle = 'rgb(0, 0, 0)';
            ctx_SD.font = '18px serif';
            ctx_SD.fillText(streamdefinition[1], x + 200, y + 80);
        }

        function addStreamDefinition() {
            var selectedIndex = document.getElementById("listNodeStreamName").selectedIndex;
            var nodename = document.getElementById("listNodeStreamName").options[selectedIndex].value;
            var streamname = document.getElementById("streamname").value;

            if (nodename != null && nodename != "" && streamname != null && streamname != "") {
                var listStreamName = document.getElementById("listStreamName");
                var option = document.createElement("option");
                option.text = streamname;
                listStreamName.add(option);

                var streamopenedTrue = document.getElementById('streamopenedTrue').checked;
                var streamdefinition = [nodename, streamname, streamopenedTrue];
                MoBlo_StreamDefinitionList.push(streamdefinition);

                //add graphic zone
                var coord = calculateMoBloCorner(MoBlo_StreamDefinitionList.length);

                if (coord[0] == 0 ) {
                    var canvas_SD = document.querySelector('.mobloStreamDefinition');
                    var height = canvas_SD.height;
                    var imgData=ctx_SD.getImageData(0,0,canvas_SD.width,canvas_SD.height);
                    canvas_SD.height = height + 160;
                    ctx_SD.putImageData(imgData,0,0);
                } 
                drawMoBloZone(ctx_SD, coord[2], coord[3]);
                drawStreamDefinition(streamdefinition, coord[2], coord[3]);

            }
        }

        function loadStreamNodes() {
            var selectedIndex = document.getElementById("listStreamName").selectedIndex;
            var streamname = document.getElementById("listStreamName").options[selectedIndex].value;

            if (MoBlo_StreamDefinitionList != null) {
                for (var i = 0; i < MoBlo_StreamDefinitionList.length; i++) {
                    if (streamname == MoBlo_StreamDefinitionList[i][1]) {

                        if (MoBlo_StreamDefinitionList[i][2]) {

                            //opened stream, everybody can publish
                            var listNodeStreamPublicationName = document.getElementById("listNodeStreamPublicationName");
                            listNodeStreamPublicationName.options.length = 0;

                            var optionall = document.createElement("option");
                            optionall.text = '*';
                            listNodeStreamPublicationName.add(optionall);

                            for (var j = 0; j < MoBlo_Nodelist.length ; j ++) {
                                var r_rights = MoBlo_AddressMap[MoBlo_Nodelist[j]];
                                if (r_rights != null) {
                                    var alreadyadded = false;
                                    for (var k = 0; k < r_rights.length; k++) {
                                        var rights = r_rights[k];
                                        if (rights[0] == 'user' && rights[1] && !alreadyadded) {
                                            var option = document.createElement("option");
                                            option.text = MoBlo_Nodelist[j];
                                            listNodeStreamPublicationName.add(option);
                                            var alreadyadded = true;
                                        }
                                    }
                                }

                            }

                        } else {

                            //closed stream only owner can publish
                            var listNodeStreamPublicationName = document.getElementById("listNodeStreamPublicationName");
                            listNodeStreamPublicationName.options.length = 0;
                            var option = document.createElement("option");
                            option.text = MoBlo_StreamDefinitionList[i][0];
                            listNodeStreamPublicationName.add(option);

                        }

                    }
                }
            }
        }

        function drawStreamPublication(publicationdefinition, x, y) {
            //Publication name
            ctx_SP.fillStyle = 'rgb(0, 102, 160)';
            ctx_SP.font = '18px serif';
            ctx_SP.fillText("publication : " + publicationdefinition[2], x + 10, y + 20);

            //Node name
            ctx_SP.fillStyle = 'rgb(0, 0, 0)';
            ctx_SP.font = '18px serif';
            ctx_SP.textAlign = "right";
            ctx_SP.fillText(publicationdefinition[1], x + 105, y + 85);
            ctx_SP.textAlign = "left";

            //Arrow
            var radiusArrow = 20;
            ctx_SP.beginPath();
            ctx_SP.lineWidth = 4;
            ctx_SP.strokeStyle = 'rgb(0, 0, 0)';
            ctx_SP.moveTo(x + 10 + 100 + 5,     y + 80);
            ctx_SP.lineTo(920, y + 80);
            ctx_SP.moveTo(920 - 1.33 * radiusArrow,     y + 80 - 0.66 * radiusArrow);
            ctx_SP.lineTo(920, y + 80);
            ctx_SP.moveTo(920 - 1.33 * radiusArrow,     y + 80 + 0.66 * radiusArrow);
            ctx_SP.lineTo(920, y + 80);
            ctx_SP.stroke();

            //Publication values
            ctx_SP.fillStyle = 'rgb(0, 0, 0)';
            ctx_SP.font = '18px serif';
            ctx_SP.textAlign = "center";
            var center = Math.trunc((x + 10 + 100 + 5)+(920 - (x + 10 + 100 + 5))/2); 
            ctx_SP.fillText('[ ' + publicationdefinition[3] + ' / ' + publicationdefinition[4] + ' ]', center, y + 65);
            ctx_SP.textAlign = "left";

            //Stream
            var radiusStream = 60;
            ctx_SP.lineWidth = 4;
            if (publicationdefinition[5]) {
                ctx_SP.setLineDash([10, 10]);
            }
            ctx_SP.strokeStyle = 'rgb(0, 0, 0)';
            ctx_SP.strokeRect(1000 - 2 * radiusStream,     y + 50, 2 * radiusStream, radiusStream);
            ctx_SP.setLineDash([1, 0]);
            if (!publicationdefinition[5]) {
                ctx_SP.strokeRect(1000 - 2 * radiusStream, y + 55, (2 * radiusStream) - 10, radiusStream -10);
            }

        }

        function addStreamPublication() {
            var selectedIndexStream = document.getElementById("listStreamName").selectedIndex;
            var streamname = document.getElementById("listStreamName").options[selectedIndexStream].value;

            var selectedIndexNode = document.getElementById("listNodeStreamPublicationName").selectedIndex;
            var nodename = document.getElementById("listNodeStreamPublicationName").options[selectedIndexNode].value;

            var publicationname = document.getElementById("streampulicationname").value;
            var publicationkey = document.getElementById("streamkey").value;
            var publicationvalue = document.getElementById("streamvalue").value;

            if (streamname != null && streamname != "" && nodename != null && nodename != ""
                    && publicationkey != null && publicationkey != "" && publicationvalue != null && publicationvalue != "") {

                var publicationdefinition = [streamname, nodename, publicationname, publicationkey, publicationvalue];

                for (var i = 0; i < MoBlo_StreamDefinitionList.length; i ++) {
                    if( MoBlo_StreamDefinitionList[i][1] == streamname ) {
                        publicationdefinition.push(MoBlo_StreamDefinitionList[i][2]);
                    }
                }

                MoBlo_PublicationDefinitionList.push(publicationdefinition);

                //add graphic zone
                var canvas_SP = document.querySelector('.mobloStreamPublication');
                var height = canvas_SP.height;
                var imgData= ctx_SP.getImageData(0,0,canvas_SP.width,canvas_SP.height);
                canvas_SP.height = height + 160;
                ctx_SP.putImageData(imgData,0,0);

                var line = MoBlo_PublicationDefinitionList.length;
                drawMoBloDoubleZone(ctx_SP, 5 + line * 160);
                drawStreamPublication(publicationdefinition, 5, 5 + line * 160);
            }
        }

        function BusinessTransaction(transactiondefinition, x, y) {
//[originname, destinationname, assetname, assetvalue, transactiondata, actionname]
            //Origin name
            ctx_BT.fillStyle = 'rgb(0, 0, 0)';
            ctx_BT.font = '18px serif';
            ctx_BT.textAlign = "right";
            ctx_BT.fillText(transactiondefinition[0], x + 105, y + 45);
            ctx_BT.textAlign = "left";

            //Destination name
            ctx_BT.fillStyle = 'rgb(0, 0, 0)';
            ctx_BT.font = '18px serif';
            ctx_BT.fillText(transactiondefinition[1], 1020 - 5 - 105, y + 45);

            //Arrow
            var radiusArrow = 20;
            ctx_BT.beginPath();
            ctx_BT.lineWidth = 4;
            ctx_BT.strokeStyle = 'rgb(0, 0, 0)';
            ctx_BT.moveTo(x + 10 + 100 + 5,     y + 40);
            ctx_BT.lineTo(1020 - 5 - 105 - 10, y + 40);
            ctx_BT.moveTo(1020 - 5 - 105 - 10 - 1.33 * radiusArrow,     y + 40 - 0.66 * radiusArrow);
            ctx_BT.lineTo(1020 - 5 - 105 - 10, y + 40);
            ctx_BT.moveTo(1020 - 5 - 105 - 10 - 1.33 * radiusArrow,     y + 40 + 0.66 * radiusArrow);
            ctx_BT.lineTo(1020 - 5 - 105 - 10, y + 40);
            ctx_BT.stroke();

            //Publication values
            ctx_BT.fillStyle = 'rgb(0, 0, 0)';
            ctx_BT.font = '18px serif';
            ctx_BT.textAlign = "center";
            var center = Math.trunc((x + 10 + 100 + 5)+(1020 - 5 - 105 - 10 - (x + 10 + 100 + 5))/2);
            var trans_text = '#t { ' + transactiondefinition[3] + ' ' + transactiondefinition[2];
            if (transactiondefinition[4] != null && transactiondefinition[4] != "") {
                trans_text = trans_text + ' [ ' + transactiondefinition[4] + ' ]'
            }
            ctx_BT.fillText( trans_text + ' }', center, y + 25);
            ctx_BT.textAlign = "left";
        }

        function addBusinessTransaction() {
            var selectedIndexOrigin = document.getElementById("listOriginNodeName").selectedIndex;
            var originname = document.getElementById("listOriginNodeName").options[selectedIndexOrigin].value;

            var selectedIndexDestination = document.getElementById("listDestinationNodeName").selectedIndex;
            var destinationname = document.getElementById("listDestinationNodeName").options[selectedIndexDestination].value;

            var selectedIndexAssetName = document.getElementById("listAssetName").selectedIndex;
            var assetname = "";
            if (selectedIndexAssetName >= 0) {
                assetname = document.getElementById("listAssetName").options[selectedIndexAssetName].value;
            }

            var actionname = document.getElementById("actionname").value;
            var assetvalue = document.getElementById("assetvalue").value;
            var transactiondata = document.getElementById("transactiondata").value;

            if (originname != null && originname != "" && destinationname != null && destinationname != "") {

                var transactiondefinition = [originname, destinationname, assetname, assetvalue, transactiondata, actionname];

                MoBlo_TransactionDefinitionList.push(transactiondefinition);

                var actionindex = -1;
                if (actionname != null && actionname != "") {
                    actionindex = MoBlo_ActionNameList.indexOf(actionname);
                }
                var nbactions = MoBlo_ActionNameList.length;
                if (actionindex == -1) {
                    MoBlo_ActionNameList.push(actionname);
                }

                var nbtransac = MoBlo_TransactionDefinitionList.length - 1;

                var yZone = 150 + nbactions * 50 + nbtransac * 60;
alert([yZone,nbactions, nbtransac]);
                //add graphic zone
                var canvas_BT = document.querySelector('.mobloBusinessTransactions');
                var imgData= ctx_BT.getImageData(0,0,canvas_BT.width,canvas_BT.height);

                canvas_BT.height = yZone + 60;
                if (actionindex == -1) {
                    canvas_BT.height = canvas_BT.height + 50;
                }
                ctx_BT.putImageData(imgData,0,0);

                if (actionindex == -1) {
                    //need to close the previous opened zone and to open a new opened zone
                    if (MoBlo_ActionNameList.length == 1) {
                        drawMoBloDoubleOpenedZone(ctx_BT, yZone, MoBlo_ActionNameList.length);
                    } else {
                        drawMoBloDoubleOpenedZone(ctx_BT, yZone + 2, MoBlo_ActionNameList.length);
                    }

                    //Publication name
                    ctx_BT.fillStyle = 'rgb(0, 102, 160)';
                    ctx_BT.font = '18px serif';
                    ctx_BT.fillText("Action : " + actionname, 15, yZone + 40);

                    yZone = yZone + 50;
                }/* else {
                    yZone = yZone + 20;
                }*/

                BusinessTransaction(transactiondefinition, 5, yZone);
            }
        }

    </script>
  </body>
</html>
