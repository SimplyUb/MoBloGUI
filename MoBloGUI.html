<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>MoBlo</title>

    <style>
        body {
            margin: 5;
            overflow-x: hidden;
            overflow-y: scroll;
            background-color: rgb(0, 102, 160);
        }
        canvas {
            overflow-x: hidden;
            overflow-y: scroll;
            background-color: rgb(250, 250, 250);
            border:1px solid #000000;
        }


        /* Style the tab */
        .tab {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
        }

        /* Style the buttons that are used to open the tab content */
        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
        }

        /* Change background color of buttons on hover */
        .tab button:hover {
            background-color: #ddd;
        }

        /* Create an active/current tablink class */
        .tab button.active {
            background-color: #ccc;
        }

        /* Style the tab content */
        .tabcontent {
            display: none;
            padding: 6px 12px;
            border: 1px solid #ccc;
            border-top: none;
        } 

    </style>

  </head>
  <body>

    <div style="padding:3px; border-top:5px dashed #fff; border-bottom:5px dashed #fff; background-color:#e3e3e3;">
        <h3>Project Definition</h3>
        Project name: <input type="text" id="project_name"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Designer name: <input type="text" id="designer_name">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<button onclick="initNames()">Give Project Names</button>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<button onclick="export_all()">Export</button>
        <br />
        <br />
    </div>
    <br />

     <!-- Tab links -->
    <div class="tab">
      <button class="tablinks" onclick="openDiagramme(event, 'PopulationMap')">Population Map</button>
      <button class="tablinks" onclick="openDiagramme(event, 'UnitDefinition')">Unit Definition</button>
      <button class="tablinks" onclick="openDiagramme(event, 'BusinessTransactions')">Business Transactions</button>
      <button class="tablinks" onclick="openDiagramme(event, 'StreamDefinition')">Stream Definition</button>
      <button class="tablinks" onclick="openDiagramme(event, 'StreamPublication')">Stream Publication</button>
    </div>

    <!-- Tab content -->
    <div id="PopulationMap" class="tabcontent">
        <div style="padding:3px; border-top:5px dashed #fff; border-bottom:5px dashed #fff; background-color:#e3e3e3;">
            <h4>Population Map</h4>
            <table>
                <tr>
                    <td valign="top">
                        Node: <input type="text" id="nodename" maxlength="5"> <button onclick="addPopulationMapNode()">---></button><select id="listNodeName"></select>
                    </td>
                    <td valign="top">
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    </td>
                    <td valign="top">
                        <input type="checkbox" id="noneRight"><label for="noneRight">Simple Node</label>
                        <br />
                        <input type="checkbox" id="connectRight"><label for="connectRight">Connect</label>
                        <br />
                        <input type="checkbox" id="sendRight"><label for="sendRight">Send</label> <input type="checkbox" id="receiveRight"><label for="receiveRight">Receive</label> 
                        <br />
                        <input type="checkbox" id="issueRight"><label for="issueRight">Issue</label> <input type="checkbox" id="createRight"><label for="createRight">Create</label> 
                        <br />
                        <input type="checkbox" id="processRight"><label for="processRight">Process</label> <input type="checkbox" id="activateRight"><label for="activateRight">Activate</label> 
                        <input type="checkbox" id="adminRight"><label for="adminRight">Admin</label> <input type="checkbox" id="originRight"><label for="originRight">Origin Node</label> 
                        <br />
                    </td>
                    <td valign="top">
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    </td>
                    <td valign="bottom">
                        <button onclick="managePopulationMapAddress()" name="PMAddAddress" id="PMAddAddress">Add Address</button>
                    </td>
                </tr>
            </table>

            <br />
            <br />
        </div>
        <br />

        <canvas class="mobloPopulationMap">
          <p>Your browser cannot be used.</p>
        </canvas>
    </div>

    <div id="UnitDefinition" class="tabcontent">
        <div style="padding:3px; border-top:5px dashed #fff; border-bottom:5px dashed #fff; background-color:#e3e3e3;">
            <h4>Unit Definition</h4>
            <table>
                <tr>
                    <td valign="top">
                        <select id="listNodeIssueName"></select>
                    </td>
                    <td valign="top">
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    </td>
                    <td valign="top">
                        Unit Name &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="text" id="unitname">
                        <br />
                        Unit Quantity &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="text" id="unitquantity" type="number">
                        <br />
                        Opened &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="radio" name="unitopened" value="true" id="unitopenedTrue" checked="checked"> True &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="radio" name="unitopened" value="false" id="unitopenedFalse"> False
                        <br />
                    </td>
                    <td valign="top">
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    </td>
                    <td valign="bottom">
                        <button onclick="manageUnitDefinition()" name="UDAddUnit" id="UDAddUnit" >Add Unit</button>
                    </td>
                </tr>
            </table>

            <br />
            <br />
        </div>
        <br />

        <canvas class="mobloUnitDefinition">
          <p>Your browser cannot be used.</p>
        </canvas>
    </div>

    <div id="BusinessTransactions" class="tabcontent">
        <div style="padding:3px; border-top:5px dashed #fff; border-bottom:5px dashed #fff; background-color:#e3e3e3;">
            <h4>Business Transactions</h4>
            <table>
                <tr>
                    <td valign="top">
                        Action Name : <input type="text" id="actionname">
                    </td>
                    <td valign="top">
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    </td>
                    <td valign="top">
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    </td>
                    <td valign="top">
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    </td>
                    <td valign="top">
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    </td>
                </tr>
                <tr>
                    <td valign="top">
                        Origin : &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <select id="listOriginNodeName"></select>
                    </td>
                    <td valign="top">
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    </td>
                    <td valign="top">
                        Destination : &nbsp;&nbsp;&nbsp; <select id="listDestinationNodeName"></select>
                    </td>
                    <td valign="top">
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    </td>
                    <td valign="top">
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    </td>
                </tr>
                <tr>
                    <td valign="top">
                        Unit : &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <select id="listAssetName" onchange="checkUD()"><option value="">___</option></select>
                    </td>
                    <td valign="top">
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    </td>
                    <td valign="top">
                        Quantity : &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="text" id="assetvalue">
                    </td>
                    <td valign="top">
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    </td>
                    <td valign="top">
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    </td>
                </tr>
                <tr>
                    <td valign="top" colspan="3">
                        Data : &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="text" id="transactiondata" size="65">
                    </td>
                    <td valign="top">
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    </td>
                    <td valign="top">
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    </td>
                </tr>
                <tr>
                    <td valign="top" colspan="3">
                        BlockChain Transaction &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="radio" name="BCTransaction" value="true" id="BCTransactionTrue" checked="checked"> True &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="radio" name="BCTransaction" value="false" id="BCTransactionFalse"> False
                    </td>
                    <td valign="top">
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    </td>
                    <td valign="top">
                        <button onclick="manageBusinessTransaction()"  name="BTAddTransaction" id="BTAddTransaction" >Add transaction</button>
                    </td>
                </tr>
                
            </table>

            <br />
            <br />
        </div>
        <br />

        <canvas class="mobloBusinessTransactions">
          <p>Your browser cannot be used.</p>
        </canvas>
    </div>

    <div id="StreamDefinition" class="tabcontent">
        <div style="padding:3px; border-top:5px dashed #fff; border-bottom:5px dashed #fff; background-color:#e3e3e3;">
            <h4>Stream Definition</h4>
            <table>
                <tr>
                    <td valign="top">
                        <select id="listNodeStreamName"></select>
                    </td>
                    <td valign="top">
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    </td>
                    <td valign="top">
                        Stream Name &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="text" id="streamname">
                        <br />
                        Opened &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="radio" checked name="streamopened" value="true" id="streamopenedTrue"> True &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="radio" name="streamopened" value="false" id="streamopenedFalse"> False
                        <br />
                    </td>
                    <td valign="top">
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    </td>
                    <td valign="bottom">
                        <button onclick="manageStreamDefinition()" name="SDAddStream" id="SDAddStream" >Add Stream</button>
                    </td>
                </tr>
            </table>

            <br />
            <br />
        </div>
        <br />

        <canvas class="mobloStreamDefinition">
          <p>Your browser cannot be used.</p>
        </canvas>
    </div>

    <div id="StreamPublication" class="tabcontent">
        <div style="padding:3px; border-top:5px dashed #fff; border-bottom:5px dashed #fff; background-color:#e3e3e3;">
            <h4>Stream Publication</h4>
            <table>
                <tr>
                    <td valign="top">
                        <select id="listStreamName" onchange="loadStreamNodes()"></select>
                    </td>
                    <td valign="top">
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    </td>
                    <td valign="top">
                        <select id="listNodeStreamPublicationName"></select>
                        <br />
                        Name : &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="text" id="streampulicationname">
                        <br />
                        Key : &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="text" id="streamkey">
                        <br />
                        Value : &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="text" id="streamvalue" size="90">
                        <br />
                    </td>
                    <td valign="top">
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    </td>
                    <td valign="bottom">
                        <button onclick="manageStreamPublication()"  name="SPPublishStream" id="SPPublishStream">Publish in Stream</button>
                    </td>
                </tr>
            </table>

            <br />
            <br />
        </div>
        <br />

        <canvas class="mobloStreamPublication">
          <p>Your browser cannot be used.</p>
        </canvas>
    </div>




    <script>
        function openDiagramme(evt, diagrammeName) {
          // Declare all variables
          var i, tabcontent, tablinks;

          // Get all elements with class="tabcontent" and hide them
          tabcontent = document.getElementsByClassName("tabcontent");
          for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
          }

          // Get all elements with class="tablinks" and remove the class "active"
          tablinks = document.getElementsByClassName("tablinks");
          for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
          }

          // Show the current tab, and add an "active" class to the button that opened the tab
          document.getElementById(diagrammeName).style.display = "block";
          evt.currentTarget.className += " active";

            if (diagrammeName == 'StreamPublication') {
                loadStreamNodes();
            }
			
			MoBlo_SelectedItem = -1;
			MoBlo_ClickedItem = -1;
        }
        
		//Export variable
		var MoBlo_Export = {};
		
		// GUI Variables
		var MoBlo_ActiveDiagramme = "";
		var MoBlo_MousePosition = {};
		var MoBlo_SelectedItem = -1;
		var MoBlo_ClickedItem = -1;
		var PM_nodeposition = [];
		var UD_unitposition = [];
		var BT_transacposition = [];
		var SD_streamposition = [];
		var SP_publiposition = [];
		
    
		//Moblo Variables
        var MoBlo_Nodelist = [];
        var MoBlo_AddressMap = {};
        var MoBlo_UnitDefinitionNb = 0;
		var MoBlo_UnitMap = {};
		var MoBlo_ActionNameList = [];
        var MoBlo_TransactionDefinitionMap = {};
        var MoBlo_StreamMap = {};
        var MoBlo_PublicationMap = {};

        var canvas_PM = document.querySelector('.mobloPopulationMap');
        var ctx_PM = canvas_PM.getContext('2d');

        initMobloZone('.mobloPopulationMap', 'Population Map', ctx_PM);
		canvas_PM.addEventListener('mousemove', function(evt) {
			MoBlo_ActiveDiagramme = 'PM';
			MoBlo_MousePosition = getMousePos(canvas_PM, evt);
			selectzone();
		}, false);
		canvas_PM.addEventListener('mouseup', function(evt) {
			clickzone();
		}, false);
		

        var canvas_UD = document.querySelector('.mobloUnitDefinition');
        var ctx_UD = canvas_UD.getContext('2d');

        initMobloZone('.mobloUnitDefinition', 'Unit Definition', ctx_UD);
		canvas_UD.addEventListener('mousemove', function(evt) {
			MoBlo_ActiveDiagramme = 'UD';
			MoBlo_MousePosition = getMousePos(canvas_UD, evt);
			selectzone();
		}, false);
		canvas_UD.addEventListener('mouseup', function(evt) {
			clickzone();
		}, false);
		

        var canvas_BT = document.querySelector('.mobloBusinessTransactions');
        var ctx_BT = canvas_BT.getContext('2d');

        initMobloZone('.mobloBusinessTransactions', 'Business Transactions', ctx_BT);
		canvas_BT.addEventListener('mousemove', function(evt) {
			MoBlo_ActiveDiagramme = 'BT';
			MoBlo_MousePosition = getMousePos(canvas_BT, evt);
			selectzone();
		}, false);
		canvas_BT.addEventListener('mouseup', function(evt) {
			clickzone();
		}, false);

        var canvas_SD = document.querySelector('.mobloStreamDefinition');
        var ctx_SD = canvas_SD.getContext('2d');

        initMobloZone('.mobloStreamDefinition', 'Stream Definition', ctx_SD);
		canvas_SD.addEventListener('mousemove', function(evt) {
			MoBlo_ActiveDiagramme = 'SD';
			MoBlo_MousePosition = getMousePos(canvas_SD, evt);
			selectzone();
		}, false);
		canvas_SD.addEventListener('mouseup', function(evt) {
			clickzone();
		}, false);

		
        var canvas_SP = document.querySelector('.mobloStreamPublication');
        var ctx_SP = canvas_SP.getContext('2d');

        initMobloZone('.mobloStreamPublication', 'Stream Publication', ctx_SP);
		canvas_SP.addEventListener('mousemove', function(evt) {
			MoBlo_ActiveDiagramme = 'SP';
			MoBlo_MousePosition = getMousePos(canvas_SP, evt);
			selectzone();
		}, false);
		canvas_SP.addEventListener('mouseup', function(evt) {
			clickzone();
		}, false);
		
		/***********************************************************
		************************************************************
		******************** EXPORT  *******************************
		************************************************************
		***********************************************************/
		function export_all() {
			MoBlo_Export = {"PM_nodeposition": PM_nodeposition};
			var export_json = JSON.stringify(MoBlo_Export);
			alert(export_json);
			//obj = JSON.parse(json);
		}

        function initNames() {
            var projectName = document.getElementById("project_name").value;
            var designerName = document.getElementById("designer_name").value;
            if (designerName == null) { designerName = ""; }
            if  (projectName != null) {
                deleteMoBloProjectNames(ctx_PM);
                deleteMoBloProjectNames(ctx_UD);
                deleteMoBloProjectNames(ctx_SD);
                drawMoBloProjectNames(ctx_PM, projectName, designerName);
                drawMoBloProjectNames(ctx_UD, projectName, designerName);
                drawMoBloProjectNames(ctx_SD, projectName, designerName);
            }
        }

        function getFormatedDate() {
            var d = new Date();
            return d.getFullYear() + " / " + (1+d.getMonth()) + " / " + d.getDate();
        }

        function initMobloZone(canvasname, zonename, ctx) {
            var canvas = document.querySelector(canvasname);
            canvas.width = 1020;
            canvas.height = 160;

            drawMoBloZone(ctx, 5, 5);

            ctx.fillStyle = 'rgb(0, 102, 160)';
            ctx.font = '18px serif';
            ctx.fillText('MoBlo - ' + zonename, 15, 25);

            ctx.font = 'italic 16px serif';
            ctx.fillText("Project :  ", 15, 85);
            ctx.fillText("Designer : ", 15, 105);

            ctx.font = '16px serif';
            ctx.fillStyle = 'rgb(0, 0, 0)';
            ctx.fillText(getFormatedDate(), 105, 55);

            ctx.fillStyle = 'rgb(125, 125, 125)';
            ctx.font = 'italic 14px serif';
            ctx.fillText('MoBlo GUI v1.0.3', 900, 25);

        }

        function drawMoBloZone(ctx, x, y) {
            ctx.lineWidth = 4;
            ctx.fillStyle = 'rgb(255, 255, 255)';
            ctx.fillRect(x, y, 500, 150);
            ctx.strokeStyle = 'rgb(0, 102, 160)';
            ctx.strokeRect(x, y, 500, 150);
        }

        function drawMoBloDoubleZone(ctx, y) {
            ctx.lineWidth = 4;
            ctx.fillStyle = 'rgb(255, 255, 255)';
            ctx.fillRect(5, y, 1010, 150);
            ctx.strokeStyle = 'rgb(0, 102, 160)';
            ctx.strokeRect(5, y, 1010, 150);
        }

        function drawMoBloDoubleOpenedZone(ctx, y, nb) {
            ctx.beginPath();
            ctx.lineWidth = 4;
            ctx.strokeStyle = 'rgb(0, 102, 160)';
            if (nb > 1) {
                ctx.moveTo(5, y + 2);
                ctx.lineTo(1010, y + 2 );
            }
            ctx.moveTo(5, y + 12);
            ctx.lineTo(1010, y + 12);
            ctx.stroke();
        }



        function drawMoBloProjectNames(ctx, projectName, designerName) {
            ctx.font = '16px serif';
            ctx.fillStyle = 'rgb(0, 0, 0)';
            ctx.fillText(projectName, 105, 85);
            ctx.fillText(designerName, 105, 105);
        }

        function deleteMoBloProjectNames(ctx) {
            ctx.fillStyle = 'rgb(255, 255, 255)';
            ctx.fillRect(99, 77, 300, 40);
        }

        function calculateMoBloCorner(index) {
            var column = (index-1) % 2;
            var line = 1 + Math.trunc((index-1)/2);
            var coord = [column, line, 5 + column * 510, 5 + line * 160];
            return coord;
        }


        function writePopulationMapName(zoneName, x, y) {
            ctx_PM.fillStyle = 'rgb(0, 102, 160)';
            ctx_PM.font = '18px serif';
            ctx_PM.fillText(zoneName, x, y);
        }

        function addPopulationMapNode() {
            var nodename = document.getElementById("nodename").value;
            if(nodename != null && nodename != "") {
                MoBlo_Nodelist.push(nodename);
                //addnode in html list
                var listNodeName = document.getElementById("listNodeName");
                var option = document.createElement("option");
                option.text = nodename;
                listNodeName.add(option);
                listNodeName.selectedIndex = listNodeName.length-1;
                var listOriginNodeName = document.getElementById("listOriginNodeName");
                var optionOrigin = document.createElement("option");
                optionOrigin.text = nodename;
                listOriginNodeName.add(optionOrigin);
                var listDestinationNodeName = document.getElementById("listDestinationNodeName");
                var optionDestination = document.createElement("option");
                optionDestination.text = nodename;
                listDestinationNodeName.add(optionDestination);
                document.getElementById("nodename").value = '';
                //add graphic zone
                var coord = calculateMoBloCorner(MoBlo_Nodelist.length);

                if (coord[0] == 0 ) {
                    var canvas_PM = document.querySelector('.mobloPopulationMap');
                    var height = canvas_PM.height;
                    var imgData=ctx_PM.getImageData(0,0,canvas_PM.width,canvas_PM.height);
                    canvas_PM.height = height + 160;
                    ctx_PM.putImageData(imgData,0,0);
                } 
                drawMoBloZone(ctx_PM, coord[2], coord[3]);
                writePopulationMapName(nodename, 5 + coord[0] * 505 + 10, 5 + coord[1] * 160 + 20);
            }
        }

        function drawSimpleNode(x, y, radius, selected, click) {
			var color = '';
			if (selected) {
				color = 'rgb(128, 128, 128)';
			} else {
				color = 'rgb(0, 0, 0)';
			}
			
            ctx_PM.fillStyle = 'rgb(255, 255, 255)';
            ctx_PM.fillRect(x-radius-5, y-radius-5, 2*radius+10, 2*radius+10);
		
			if (click) {
				ctx_PM.beginPath();
				ctx_PM.strokeStyle = 'rgb(153, 217, 234)';
				ctx_PM.lineWidth = 10;
				ctx_PM.arc(x,y,radius,0,2*Math.PI);
				ctx_PM.stroke();
			}
			
            ctx_PM.beginPath();
            ctx_PM.strokeStyle = color;
            ctx_PM.lineWidth = 4;
            ctx_PM.arc(x,y,radius,0,2*Math.PI);
            ctx_PM.stroke();
        }


        function drawConnectNode(x, y, radius, selected, click) {
			var color = '';
			if (selected) {
				color = 'rgb(128, 128, 128)';
			} else {
				color = 'rgb(0, 0, 0)';
			}
			
            ctx_PM.fillStyle = 'rgb(255, 255, 255)';
            ctx_PM.fillRect(x-radius-5, y-radius-5, 2*radius+10, 2*radius+10);
			
			if (click) {
				ctx_PM.beginPath();
				ctx_PM.strokeStyle = 'rgb(153, 217, 234)';
				ctx_PM.lineWidth = 10;
				ctx_PM.arc(x,y,radius,0,2*Math.PI);
				ctx_PM.stroke();
			}
			
			ctx_PM.beginPath();
            ctx_PM.strokeStyle = color;
			ctx_PM.lineWidth = 4;
            ctx_PM.arc(x,y,radius,0,2*Math.PI);
            ctx_PM.stroke();
			
            ctx_PM.beginPath();
            ctx_PM.fillStyle = 'rgb(255, 255, 255)';
            ctx_PM.lineWidth = 8;
            ctx_PM.arc(x,y+radius,radius*0.4,0,2*Math.PI);
            ctx_PM.fill();

            ctx_PM.beginPath();
            ctx_PM.strokeStyle = color;
			ctx_PM.lineWidth = 4;
            ctx_PM.arc(x,y+radius,radius*0.4,0,2*Math.PI);
            ctx_PM.stroke();
        }


        function drawBizNode(rights, x, y, radius, selected, click) {
			var color = '';
			if (selected) {
				color = 'rgb(128, 128, 128)';
			} else {
				color = 'rgb(0, 0, 0)';
			}
			
            ctx_PM.fillStyle = 'rgb(255, 255, 255)';
            ctx_PM.fillRect(x-radius-5, y-radius-5, 2*radius+10, 2*radius+10);
			
			if (click) {
				ctx_PM.beginPath();
				ctx_PM.strokeStyle = 'rgb(153, 217, 234)';
				ctx_PM.lineWidth = 10;
				ctx_PM.arc(x,y,radius,0,2*Math.PI);
				ctx_PM.stroke();
			}
			
            ctx_PM.beginPath();
            ctx_PM.strokeStyle = color;
            ctx_PM.lineWidth = 4;
            ctx_PM.arc(x,y,radius,0,2*Math.PI);
            ctx_PM.stroke();

            //send
            if(rights.send) {
                ctx_PM.beginPath();
                ctx_PM.lineWidth = 8;
                ctx_PM.strokeStyle = 'rgb(255, 255, 255)';
                ctx_PM.moveTo(x-radius,     y+radius*0.1+radius);
                ctx_PM.lineTo(x-radius*0.4, y+radius*0.1+radius*0.4);
                ctx_PM.moveTo(x-radius*0.4, y+radius*0.1+radius);
                ctx_PM.lineTo(x-radius,     y+radius*0.1+radius*0.4);
                ctx_PM.stroke();
                ctx_PM.beginPath();
                ctx_PM.lineWidth = 4;
                ctx_PM.strokeStyle = color;
                ctx_PM.moveTo(x-radius,     y+radius*0.1+radius);
                ctx_PM.lineTo(x-radius*0.4, y+radius*0.1+radius*0.4);
                ctx_PM.moveTo(x-radius*0.4, y+radius*0.1+radius);
                ctx_PM.lineTo(x-radius,     y+radius*0.1+radius*0.4);
                ctx_PM.stroke();
            }

            //receive
            if(rights.receive) {
                ctx_PM.lineWidth = 8;
                ctx_PM.strokeStyle = 'rgb(255, 255, 255)';
                ctx_PM.strokeRect(x+radius,     y+radius*0.1+radius, -radius*0.6, -radius*0.6);
                ctx_PM.lineWidth = 4;
                ctx_PM.strokeStyle = color;
                ctx_PM.strokeRect(x+radius,     y+radius*0.1+radius, -radius*0.6, -radius*0.6);
            }


            //issue
            if(rights.issue) {
                ctx_PM.beginPath();
                ctx_PM.lineWidth = 8;
                ctx_PM.strokeStyle = 'rgb(255, 255, 255)';
                ctx_PM.moveTo(x+radius,     y-radius*0.1-radius*0.4);
                ctx_PM.lineTo(x+radius*0.4, y-radius*0.1-radius*0.4);
                ctx_PM.lineTo(x+radius*0.7, y-radius*0.1-radius);
                ctx_PM.lineTo(x+radius,     y-radius*0.1-radius*0.4);
                ctx_PM.stroke();
                ctx_PM.beginPath();
                ctx_PM.lineWidth = 4;
                ctx_PM.strokeStyle = color;
                ctx_PM.moveTo(x+radius,     y-radius*0.1-radius*0.4);
                ctx_PM.lineTo(x+radius*0.4, y-radius*0.1-radius*0.4);
                ctx_PM.lineTo(x+radius*0.7, y-radius*0.1-radius);
                ctx_PM.lineTo(x+radius,     y-radius*0.1-radius*0.4);
                ctx_PM.stroke();
            }

            //create
            if(rights.create) {
                ctx_PM.beginPath();
                ctx_PM.lineWidth = 8;
                ctx_PM.strokeStyle = 'rgb(255, 255, 255)';
                ctx_PM.moveTo(x-0.83*radius,     y-radius*0.08-radius);
                ctx_PM.lineTo(x-0.6*radius*0.4, y-radius*0.15-radius*0.4);
                ctx_PM.moveTo(x-radius,     y-0.9*radius);
                ctx_PM.lineTo(x-radius*0.4, y-0.9*radius*0.4);
                ctx_PM.stroke();
                ctx_PM.beginPath();
                ctx_PM.lineWidth = 4;
                ctx_PM.strokeStyle = color;
                ctx_PM.moveTo(x-0.83*radius,     y-radius*0.08-radius);
                ctx_PM.lineTo(x-0.6*radius*0.4, y-radius*0.15-radius*0.4);
                ctx_PM.moveTo(x-radius,     y-0.9*radius);
                ctx_PM.lineTo(x-radius*0.4, y-0.9*radius*0.4);
                ctx_PM.stroke();
            }
        }

        function drawAdminNode(rights, x, y, radius, selected, click) {
			var color = '';
			if (selected) {
				color = 'rgb(128, 128, 128)';
			} else {
				color = 'rgb(0, 0, 0)';
			}
			
            ctx_PM.fillStyle = 'rgb(255, 255, 255)';
            ctx_PM.fillRect(x-radius-5, y-radius-5, 2*radius+10, 2*radius+10);
			
			if (click) {
				ctx_PM.beginPath();
				ctx_PM.strokeStyle = 'rgb(153, 217, 234)';
				ctx_PM.lineWidth = 10;
				ctx_PM.arc(x,y,radius,0,2*Math.PI);
				ctx_PM.stroke();
			}
			
            ctx_PM.beginPath();
            ctx_PM.strokeStyle = color;
            ctx_PM.lineWidth = 4;
            ctx_PM.arc(x,y,radius,0,2*Math.PI);
            ctx_PM.stroke();

            //admin
            if(rights.origin || rights.admin) {
                ctx_PM.beginPath();
                ctx_PM.strokeStyle = color;
                ctx_PM.lineWidth = 4;
                ctx_PM.arc(x,y,radius*0.8,0,2*Math.PI);
                ctx_PM.stroke();
            }

            //mine
            if(rights.process) {
                ctx_PM.beginPath();
                ctx_PM.fillStyle = color;
                ctx_PM.lineWidth = 4;
                ctx_PM.arc(x,y,radius*0.4,0,2*Math.PI);
                ctx_PM.fill();
            }

            //activate            
            if(rights.origin || rights.activate) {
                ctx_PM.beginPath();
                ctx_PM.lineWidth = 8;
                ctx_PM.strokeStyle = 'rgb(255, 255, 255)';
                ctx_PM.moveTo(x-radius,     y-radius);
                ctx_PM.lineTo(x-radius*0.4, y-radius*0.4);
                ctx_PM.stroke();
                ctx_PM.beginPath();
                ctx_PM.lineWidth = 4;
                ctx_PM.strokeStyle = color;
                ctx_PM.moveTo(x-radius,     y-radius);
                ctx_PM.lineTo(x-radius*0.4, y-radius*0.4);
                ctx_PM.stroke();
            }
        }
		
		function getPMNoderights(nodename, rightsindex, rightsname) {
			var rights = MoBlo_AddressMap[nodename][rightsindex];
			if (rights.name == rightsname) {
				return rights;
			}
		}
		
		function modifyPMNoderights(nodename, rightsindex, rightsname, newrights) {
			var rights = MoBlo_AddressMap[nodename][rightsindex];
			if (rights.name == rightsname) {
				MoBlo_AddressMap[nodename][rightsindex]=newrights;
			}
		}
		
		
		
		function managePopulationMapAddress() {
			if (MoBlo_ClickedItem >= 0) {
				modifyPopulationMapAddress();
			} else {
				addPopulationMapAddress();
			}
		}
		
        function modifyPopulationMapAddress() {
			var connectRight = document.getElementById('connectRight').checked;
			var sendRight = document.getElementById('sendRight').checked;
			var receiveRight = document.getElementById('receiveRight').checked;
			var issueRight = document.getElementById('issueRight').checked;
			var createRight = document.getElementById('createRight').checked;
			var processRight = document.getElementById('processRight').checked;
			var activateRight = document.getElementById('activateRight').checked;
			var adminRight = document.getElementById('adminRight').checked;
			var originRight = document.getElementById('originRight').checked;
		
			var positionlist = PM_nodeposition;
			var rights = getPMNoderights(positionlist[MoBlo_ClickedItem].nodename, positionlist[MoBlo_ClickedItem].rightsindex, positionlist[MoBlo_ClickedItem].rightsname);
			var newrights = {};
			
			if (rights.name == 'user') {
				newrights = { name : 'user', send : sendRight, receive : receiveRight, issue : issueRight, create : createRight};
				drawBizNode(newrights, positionlist[MoBlo_ClickedItem].x, positionlist[MoBlo_ClickedItem].y, positionlist[MoBlo_ClickedItem].radius, false, true);
				
                if (issueRight) {
                   var listNodeIssueName = document.getElementById("listNodeIssueName");
                    var option = document.createElement("option");
                    option.text = positionlist[MoBlo_ClickedItem].nodename;
                    listNodeIssueName.add(option);
                }

                if (createRight) {

                    var listNodeStreamName = document.getElementById("listNodeStreamName");
                    var option = document.createElement("option");
                    option.text = positionlist[MoBlo_ClickedItem].nodename;
                    listNodeStreamName.add(option);
                }				
				
			} else if (rights.name == 'control') {
				newrights = {name: 'control', connect: connectRight};
				drawConnectNode(positionlist[MoBlo_ClickedItem].x, positionlist[MoBlo_ClickedItem].y, positionlist[MoBlo_ClickedItem].radius, false, false);
				
			} else if (rights.name == 'admin') {
				newrights = { name: 'admin', origin: originRight, admin: adminRight, activate: activateRight, process: processRight};
				drawAdminNode(newrights, positionlist[MoBlo_ClickedItem].x, positionlist[MoBlo_ClickedItem].y, positionlist[MoBlo_ClickedItem].radius, false, true);
			}
			modifyPMNoderights(positionlist[MoBlo_ClickedItem].nodename, positionlist[MoBlo_ClickedItem].rightsindex, positionlist[MoBlo_ClickedItem].rightsname, newrights);
		}

        function addPopulationMapAddress() {
            var selectedIndex = document.getElementById("listNodeName").selectedIndex;
            var nodename = document.getElementById("listNodeName").options[selectedIndex].value;

            if (nodename != null && nodename != "") {
            	var noneRight = document.getElementById('noneRight').checked;
                var connectRight = document.getElementById('connectRight').checked;
                var sendRight = document.getElementById('sendRight').checked;
                var receiveRight = document.getElementById('receiveRight').checked;
                var issueRight = document.getElementById('issueRight').checked;
                var createRight = document.getElementById('createRight').checked;
                var processRight = document.getElementById('processRight').checked;
                var activateRight = document.getElementById('activateRight').checked;
                var adminRight = document.getElementById('adminRight').checked;
                var originRight = document.getElementById('originRight').checked;

                if (originRight || adminRight || activateRight || processRight) {

                    var rights = { name: 'admin', origin: originRight, admin: adminRight, activate: activateRight, process: processRight};
                    if (MoBlo_AddressMap[nodename] == null ) {
                        var r_rights = [rights];
                        MoBlo_AddressMap[nodename] = r_rights;
                    } else {
                        var r_rights = MoBlo_AddressMap[nodename];
                        r_rights.push(rights);
                        MoBlo_AddressMap[nodename] = r_rights;
                    }
					var rightsindex = MoBlo_AddressMap[nodename].length - 1;

                    if (rightsindex > 5) {
						alert("MAX 6 addresses per node !");
						return;
					}
					if (MoBlo_Nodelist != null) {
                        var nodeindex = MoBlo_Nodelist.indexOf(nodename);
                        
                        var coord = calculateMoBloCorner(nodeindex+1);
                        var radius = 30;
                        var x = coord[2] + radius + 20;
                        var y = coord[3] + radius + 50;

                        x = x + ((MoBlo_AddressMap[nodename].length -1) * (2*radius + 10));

                        drawAdminNode(rights, x, y, radius, false, false);
						PM_nodeposition.push({limit: { xmin: x-radius, ymin: y-radius, xmax: x+radius, ymax: y+radius}, rightsname: rights.name, rightsindex: rightsindex, x: x, y: y, radius: radius, nodename: nodename, selectedIndex:selectedIndex});
                    }
					
					document.getElementById('processRight').checked = false;
					document.getElementById('activateRight').checked = false;
					document.getElementById('adminRight').checked = false;
					document.getElementById('originRight').checked = false;
                }

                if (sendRight || receiveRight || issueRight || createRight) {

                    var rights = { name : 'user', send : sendRight, receive : receiveRight, issue : issueRight, create : createRight};
                    if (MoBlo_AddressMap[nodename] == null ) {
                        var r_rights = [rights];
                        MoBlo_AddressMap[nodename] = r_rights;
                    } else {
                        var r_rights = MoBlo_AddressMap[nodename];
                        r_rights.push(rights);
                        MoBlo_AddressMap[nodename] = r_rights;
                    }
					var rightsindex = MoBlo_AddressMap[nodename].length - 1;

                    if (rightsindex > 5) {
						alert("MAX 6 addresses per node !");
						return;
					}
                    if (MoBlo_Nodelist != null) {
                        var nodeindex = MoBlo_Nodelist.indexOf(nodename);
                        
                        var coord = calculateMoBloCorner(nodeindex+1);
                        var radius = 30;
                        var x = coord[2] + radius + 20;
                        var y = coord[3] + radius + 50;

                        x = x + ((MoBlo_AddressMap[nodename].length -1) * (2*radius + 10));

                        drawBizNode(rights, x, y, radius, false, false);
						PM_nodeposition.push({limit: { xmin: x-radius, ymin: y-radius, xmax: x+radius, ymax: y+radius}, rightsname: rights.name, rightsindex: rightsindex,  x: x, y: y, radius: radius, nodename: nodename, selectedIndex:selectedIndex});						
                    }
					
					document.getElementById('sendRight').checked = false;
					document.getElementById('receiveRight').checked = false;
					document.getElementById('issueRight').checked = false;
					document.getElementById('createRight').checked = false;
                }

                if (issueRight) {

                    var listNodeIssueName = document.getElementById("listNodeIssueName");
                    var option = document.createElement("option");
                    option.text = nodename;
                    listNodeIssueName.add(option);

                }

                if (createRight) {

                    var listNodeStreamName = document.getElementById("listNodeStreamName");
                    var option = document.createElement("option");
                    option.text = nodename;
                    listNodeStreamName.add(option);
                }


                if (connectRight) {

                    var rights = {name: 'control', connect: connectRight};
                    if (MoBlo_AddressMap[nodename] == null ) {
                        var r_rights = [rights];
                        MoBlo_AddressMap[nodename] = r_rights;
                    } else {
                        var r_rights = MoBlo_AddressMap[nodename];
                        r_rights.push(rights);
                        MoBlo_AddressMap[nodename] = r_rights;
                    }
					var rightsindex = MoBlo_AddressMap[nodename].length - 1;

                    if (rightsindex > 5) {
						alert("MAX 6 addresses per node !");
						return;
					}
                    if (MoBlo_Nodelist != null) {
                        var nodeindex = MoBlo_Nodelist.indexOf(nodename);
                        
                        var coord = calculateMoBloCorner(nodeindex+1);
                        var radius = 30;
                        var x = coord[2] + radius + 20;
                        var y = coord[3] + radius + 50;

                        x = x + ((MoBlo_AddressMap[nodename].length -1) * (2*radius + 10));

                        drawConnectNode(x, y, radius, false, false);
						PM_nodeposition.push({limit: { xmin: x-radius, ymin: y-radius, xmax: x+radius, ymax: y+radius}, rightsname: rights.name, rightsindex: rightsindex,  x: x, y: y, radius: radius, nodename: nodename, selectedIndex:selectedIndex});
                    }
					
					document.getElementById('connectRight').checked = false;
                }
                
                
                if (noneRight) {

                    var rights = {name: 'simple', simple: noneRight};
                    if (MoBlo_AddressMap[nodename] == null ) {
                        var r_rights = [rights];
                        MoBlo_AddressMap[nodename] = r_rights;
                    } else {
                        var r_rights = MoBlo_AddressMap[nodename];
                        r_rights.push(rights);
                        MoBlo_AddressMap[nodename] = r_rights;
                    }
					var rightsindex = MoBlo_AddressMap[nodename].length - 1;

                    if (rightsindex > 5) {
						alert("MAX 6 addresses per node !");
						return;
					}
                    if (MoBlo_Nodelist != null) {
                        var nodeindex = MoBlo_Nodelist.indexOf(nodename);
                        
                        var coord = calculateMoBloCorner(nodeindex+1);
                        var radius = 30;
                        var x = coord[2] + radius + 20;
                        var y = coord[3] + radius + 50;

                        x = x + ((MoBlo_AddressMap[nodename].length -1) * (2*radius + 10));

                        drawSimpleNode(x, y, radius, false, false);
						PM_nodeposition.push({limit: { xmin: x-radius, ymin: y-radius, xmax: x+radius, ymax: y+radius}, rightsname: rights.name, rightsindex: rightsindex,  x: x, y: y, radius: radius, nodename: nodename, selectedIndex:selectedIndex});
                    }
					
					document.getElementById('noneRight').checked = false;
                }
            }

        }
		
		/**************************************************************
		***************************************************************
		***************** Unit Definition *****************************
		***************************************************************
		**************************************************************/
		function checkUD() {
			var selectedIndexAssetName = document.getElementById("listAssetName").selectedIndex;
			if (selectedIndexAssetName == 0) {
				document.getElementById("assetvalue").disabled = true;
			} else {
				document.getElementById("assetvalue").disabled = false;
			}
		}
		
		
        function drawUnitDefinition(unitdefinition, x, y, radius, selected, click) {
			var color = '';
			if (selected) {
				color = 'rgb(128, 128, 128)';
			} else {
				color = 'rgb(0, 0, 0)';
			}
			
            ctx_UD.fillStyle = 'rgb(255, 255, 255)';
            ctx_UD.fillRect(x + 5, y + 5, 490, 140);
			
			if (click) {
				ctx_UD.beginPath();
				ctx_UD.strokeStyle = 'rgb(153, 217, 234)';
				ctx_UD.lineWidth = 10;
				ctx_UD.moveTo(x + 75 + radius,     y + 50 + radius);
				ctx_UD.lineTo(x + 75,              y + 50 + radius);
				ctx_UD.lineTo(x + 75 + radius*0.5, y + 50);
				if (!unitdefinition.unitopenedTrue) {
					ctx_UD.lineTo(x + 75 + radius,     y + 50 + radius);
				}
				ctx_UD.stroke();
			}
			
            //Node name
            ctx_UD.fillStyle = 'rgb(0, 102, 160)';
            ctx_UD.font = '18px serif';
            ctx_UD.fillText("owner : " + unitdefinition.nodename, x + 10, y + 20);

            //Unit
            ctx_UD.beginPath();
            ctx_UD.lineWidth = 4;
            ctx_UD.strokeStyle = color;
            ctx_UD.moveTo(x + 75 + radius,     y + 50 + radius);
            ctx_UD.lineTo(x + 75,              y + 50 + radius);
            ctx_UD.lineTo(x + 75 + radius*0.5, y + 50);
            if (!unitdefinition.unitopenedTrue) {
                ctx_UD.lineTo(x + 75 + radius,     y + 50 + radius);
            }
            ctx_UD.stroke();

            //Unit name
            ctx_UD.fillStyle = color;
            ctx_UD.font = '18px serif';
            ctx_UD.fillText(unitdefinition.unitname, x + 200, y + 80);

            //Unit quantity
            ctx_UD.fillStyle = color;
            ctx_UD.font = 'italic 14px serif';
            ctx_UD.fillText(unitdefinition.unitquantity, x + 65, y + 130);
        }
		
		function manageUnitDefinition() {
			if (MoBlo_ClickedItem >= 0) {
				modifyUnitDefinition();
			} else {
				addUnitDefinition();
			}
		}
		
        function modifyUnitDefinition() {
            var selectedIndex = document.getElementById("listNodeIssueName").selectedIndex;
            var nodename = document.getElementById("listNodeIssueName").options[selectedIndex].value;
            var unitname = document.getElementById("unitname").value;
            var unitquantity = document.getElementById("unitquantity").value;
			var unitopenedTrue = document.getElementById('unitopenedTrue').checked;
			
			var newunitdefinition = {nodename: nodename, unitname: unitname, unitopenedTrue: unitopenedTrue, unitquantity: unitquantity};
			
			var unitposition = UD_unitposition[MoBlo_ClickedItem];
			
			drawUnitDefinition(newunitdefinition, unitposition.x, unitposition.y, unitposition.radius, false, true);
			
			MoBlo_UnitMap[unitname]=unitdefinition;
		}		

        function addUnitDefinition() {
            var selectedIndex = document.getElementById("listNodeIssueName").selectedIndex;
            var nodename = document.getElementById("listNodeIssueName").options[selectedIndex].value;
            var unitname = document.getElementById("unitname").value;
            var unitquantity = document.getElementById("unitquantity").value;
			
            if (nodename != null && nodename != "" && unitname != null && unitname != "") {
				if(MoBlo_UnitMap[unitname]!=null) {
					document.getElementById("unitname").value = "";
					alert("Unit already exists !");
					return;
				}
			
                var unitopenedTrue = document.getElementById('unitopenedTrue').checked;
                var unitdefinition = {nodename: nodename, unitname: unitname, unitopenedTrue: unitopenedTrue, unitquantity: unitquantity};
				MoBlo_UnitMap[unitname]=unitdefinition;
				MoBlo_UnitDefinitionNb = MoBlo_UnitDefinitionNb+1;

                var listAssetName = document.getElementById("listAssetName");
                var optionAsset = document.createElement("option");
                optionAsset.text = unitname;
                listAssetName.add(optionAsset);

                //add graphic zone
                var coord = calculateMoBloCorner(MoBlo_UnitDefinitionNb);

                if (coord[0] == 0 ) {
                    var canvas_UD = document.querySelector('.mobloUnitDefinition');
                    var height = canvas_UD.height;
                    var imgData=ctx_UD.getImageData(0,0,canvas_UD.width,canvas_UD.height);
                    canvas_UD.height = height + 160;
                    ctx_UD.putImageData(imgData,0,0);
                }
				var radius = 60;
                drawMoBloZone(ctx_UD, coord[2], coord[3]);
                drawUnitDefinition(unitdefinition, coord[2], coord[3], radius, false, false);
				UD_unitposition.push({limit: { xmin: coord[2] + 75, ymin: coord[3]+50, xmax: coord[2]+75+radius, ymax: coord[3]+50+radius},  x: coord[2], y: coord[3], unitname: unitname, nodeindex: selectedIndex, radius: radius});
            }
			document.getElementById("unitname").value = "";
            document.getElementById("unitquantity").value = "";
			document.getElementById('unitopenedTrue').checked = true;
			document.getElementById('unitopenedFalse').checked = false;
        }
		
		/**************************************************************
		***************************************************************
		***************** Stream Definition ***************************
		***************************************************************
		**************************************************************/
        function drawStreamDefinition(streamdefinition, x, y, selected, click) {
			var color = '';
			if (selected) {
				color = 'rgb(128, 128, 128)';
			} else {
				color = 'rgb(0, 0, 0)';
			}
			
            var radius = 60;
			
            ctx_SD.fillStyle = 'rgb(255, 255, 255)';
            ctx_SD.fillRect(x + 5, y + 5, 490, radius + 45);
			
			if (click) {
				ctx_SD.lineWidth = 10;
				ctx_SD.strokeStyle = 'rgb(153, 217, 234)';
				ctx_SD.strokeRect(x + 45,     y + 50, 2 * radius, radius);
			}
			
            //Node name
            ctx_SD.fillStyle = 'rgb(0, 102, 160)';
            ctx_SD.font = '18px serif';
            ctx_SD.fillText("owner : " + streamdefinition.nodename, x + 10, y + 20);

            //Stream
            ctx_SD.lineWidth = 4;
            if (streamdefinition.streamopenedTrue) {
                ctx_SD.setLineDash([10, 10]);
            }
            ctx_SD.strokeStyle = color;
            ctx_SD.strokeRect(x + 45,     y + 50, 2 * radius, radius);
            ctx_SD.setLineDash([1, 0]);
            if (!streamdefinition.streamopenedTrue) {
                ctx_SD.strokeRect(x + 50,     y + 55, (2 * radius) - 10, radius -10);
            }

            //Stream name
            ctx_SD.fillStyle = color;
            ctx_SD.font = '18px serif';
            ctx_SD.fillText(streamdefinition.streamname, x + 200, y + 80);
        }

		function manageStreamDefinition() {
			if (MoBlo_ClickedItem >= 0) {
				modifyStreamDefinition();
			} else {
				addStreamDefinition();
			}
		}
				
        function modifyStreamDefinition() {
            var selectedIndex = document.getElementById("listNodeStreamName").selectedIndex;
            var nodename = document.getElementById("listNodeStreamName").options[selectedIndex].value;
            var streamname = document.getElementById("streamname").value;
			var streamopenedTrue = document.getElementById('streamopenedTrue').checked;
			
			var newstreamdefinition = {nodename:nodename, streamname:streamname, streamopenedTrue:streamopenedTrue};
			
			var streamposition = SD_streamposition[MoBlo_ClickedItem];
			
			drawStreamDefinition(newstreamdefinition, streamposition.x, streamposition.y, false, true);
			
			SD_streamposition[MoBlo_ClickedItem].streamdefinition = newstreamdefinition;
		}			
		
        function addStreamDefinition() {
            var selectedIndex = document.getElementById("listNodeStreamName").selectedIndex;
            var nodename = document.getElementById("listNodeStreamName").options[selectedIndex].value;
            var streamname = document.getElementById("streamname").value;

            if (nodename != null && nodename != "" && streamname != null && streamname != "") {
				if(MoBlo_StreamMap[streamname]!=null) {
					document.getElementById("streamname").value = "";
					alert("Stream already exists !");
					return;
				}
            	
                var listStreamName = document.getElementById("listStreamName");
                var option = document.createElement("option");
                option.text = streamname;
                listStreamName.add(option);

                var streamopenedTrue = document.getElementById('streamopenedTrue').checked;
                var streamdefinition = {nodename:nodename, streamname:streamname, streamopenedTrue:streamopenedTrue};
                MoBlo_StreamMap[streamname]=streamdefinition;

                //add graphic zone
                var coord = calculateMoBloCorner(Object.keys(MoBlo_StreamMap).length);

                if (coord[0] == 0 ) {
                    var canvas_SD = document.querySelector('.mobloStreamDefinition');
                    var height = canvas_SD.height;
                    var imgData=ctx_SD.getImageData(0,0,canvas_SD.width,canvas_SD.height);
                    canvas_SD.height = height + 160;
                    ctx_SD.putImageData(imgData,0,0);
                } 
                drawMoBloZone(ctx_SD, coord[2], coord[3]);
                drawStreamDefinition(streamdefinition, coord[2], coord[3]);
				SD_streamposition.push({limit: { xmin: coord[2] + 45, ymin: coord[3] + 40, xmax: coord[2] + 165, ymax:  coord[3] + 120}, x: coord[2], y: coord[3], streamdefinition: streamdefinition, nodeindex: selectedIndex});
            }
            
            document.getElementById("streamname").value = "";
			document.getElementById('streamopenedTrue').checked = true;
			document.getElementById('streamopenedFalse').checked = false;
            
        }

		/**************************************************************
		***************************************************************
		***************** Stream Publication **************************
		***************************************************************
		**************************************************************/
        function loadStreamNodes() {
            var selectedIndex = document.getElementById("listStreamName").selectedIndex;
            var streamname = document.getElementById("listStreamName").options[selectedIndex].value;

            if (MoBlo_StreamMap != null) {
            	
            	var streamdefinition=MoBlo_StreamMap[streamname];
            	
            	if (streamdefinition.streamopenedTrue) {
	                //opened stream, everybody can publish
	                var listNodeStreamPublicationName = document.getElementById("listNodeStreamPublicationName");
	                listNodeStreamPublicationName.options.length = 0;
	
	                var optionall = document.createElement("option");
	                optionall.text = '*';
	                listNodeStreamPublicationName.add(optionall);
	
	                for (var j = 0; j < MoBlo_Nodelist.length ; j ++) {
	                    var r_rights = MoBlo_AddressMap[MoBlo_Nodelist[j]];
	                    if (r_rights != null) {
	                        var alreadyadded = false;
	                        for (var k = 0; k < r_rights.length; k++) {
	                            var rights = r_rights[k];
	                            if (rights.name == 'user' && rights.send && !alreadyadded) {
	                                var option = document.createElement("option");
	                                option.text = MoBlo_Nodelist[j];
	                                listNodeStreamPublicationName.add(option);
	                                var alreadyadded = true;
	                            }
	                        }
	                    }
	
	                }
            		
            	} else {
                    //closed stream only owner can publish
                    var listNodeStreamPublicationName = document.getElementById("listNodeStreamPublicationName");
                    listNodeStreamPublicationName.options.length = 0;
                    var option = document.createElement("option");
                    option.text = streamdefinition.nodename;
                    listNodeStreamPublicationName.add(option);
            	}
            	
            	
            }
        }

        function drawStreamPublication(publicationdefinition, x, y, selected, click) {
			var color = '';
			if (selected) {
				color = 'rgb(128, 128, 128)';
			} else {
				color = 'rgb(0, 0, 0)';
			}
			
            ctx_SP.fillStyle = 'rgb(255, 255, 255)';
            ctx_SP.fillRect(x+5, y+5, 1000, 140);
			
            var radiusArrow = 20;
            var radiusStream = 60;
			
			if (click) {
				ctx_SP.beginPath();
				ctx_SP.strokeStyle = 'rgb(153, 217, 234)';
				ctx_SP.lineWidth = 10;
				ctx_SP.moveTo(x + 10 + 100 + 5,     y + 80);
				ctx_SP.lineTo(920, y + 80);
				ctx_SP.moveTo(920 - 1.33 * radiusArrow,     y + 80 - 0.66 * radiusArrow);
				ctx_SP.lineTo(920, y + 80);
				ctx_SP.moveTo(920 - 1.33 * radiusArrow,     y + 80 + 0.66 * radiusArrow);
				ctx_SP.lineTo(920, y + 80);
				ctx_SP.stroke();
				
				ctx_SP.lineWidth = 10;
				ctx_SP.strokeStyle = 'rgb(153, 217, 234)';
				ctx_SP.strokeRect(1000 - 2 * radiusStream,     y + 50, 2 * radiusStream, radiusStream);
			}
			
            //Publication name
            ctx_SP.fillStyle = 'rgb(0, 102, 160)';
            ctx_SP.font = '18px serif';
            ctx_SP.fillText("publication : " + publicationdefinition.publicationname, x + 10, y + 20);

            //Node name
            ctx_SP.fillStyle = color;
            ctx_SP.font = '18px serif';
            ctx_SP.textAlign = "right";
            ctx_SP.fillText(publicationdefinition.nodename, x + 105, y + 85);
            ctx_SP.textAlign = "left";

            //Arrow
            ctx_SP.beginPath();
            ctx_SP.lineWidth = 4;
            ctx_SP.strokeStyle = color;
            ctx_SP.moveTo(x + 10 + 100 + 5,     y + 80);
            ctx_SP.lineTo(920, y + 80);
            ctx_SP.moveTo(920 - 1.33 * radiusArrow,     y + 80 - 0.66 * radiusArrow);
            ctx_SP.lineTo(920, y + 80);
            ctx_SP.moveTo(920 - 1.33 * radiusArrow,     y + 80 + 0.66 * radiusArrow);
            ctx_SP.lineTo(920, y + 80);
            ctx_SP.stroke();

            //Publication values
            ctx_SP.fillStyle = color;
            ctx_SP.font = '18px serif';
            ctx_SP.textAlign = "center";
            var center = Math.trunc((x + 10 + 100 + 5)+(920 - (x + 10 + 100 + 5))/2); 
            ctx_SP.fillText('[ ' + publicationdefinition.publicationkey + ' / ' + publicationdefinition.publicationvalue + ' ]', center, y + 65);
            ctx_SP.textAlign = "left";

            //Stream
            ctx_SP.lineWidth = 4;
            if (publicationdefinition.streamdefinition.streamopenedTrue) {
                ctx_SP.setLineDash([10, 10]);
            }
            ctx_SP.strokeStyle = color;
            ctx_SP.strokeRect(1000 - 2 * radiusStream,     y + 50, 2 * radiusStream, radiusStream);
            ctx_SP.setLineDash([1, 0]);
            if (!publicationdefinition.streamdefinition.streamopenedTrue) {
                ctx_SP.strokeRect(1000 - 2 * radiusStream +5, y + 55, (2 * radiusStream) - 10, radiusStream -10);
            }
            
            //Stream Name
            ctx_SP.fillStyle = color;
            ctx_SP.font = '18px serif';
            ctx_SP.textAlign = "center";
            ctx_SP.fillText(publicationdefinition.streamname, 1000 - radiusStream, y + 40);
            ctx_SP.textAlign = "left";
        }

		function manageStreamPublication() {
			if (MoBlo_ClickedItem >= 0) {
				modifyStreamPublication();
			} else {
				addStreamPublication();
			}
		}
				
        function modifyStreamPublication() {
            var selectedIndexStream = document.getElementById("listStreamName").selectedIndex;
            var streamname = document.getElementById("listStreamName").options[selectedIndexStream].value;

            var selectedIndexNode = document.getElementById("listNodeStreamPublicationName").selectedIndex;
            var nodename = document.getElementById("listNodeStreamPublicationName").options[selectedIndexNode].value;

            var publicationname = document.getElementById("streampulicationname").value;
            var publicationkey = document.getElementById("streamkey").value;
            var publicationvalue = document.getElementById("streamvalue").value;
            
            var newpublicationdefinition = {streamname:streamname, nodename:nodename, publicationname:publicationname, publicationkey:publicationkey, publicationvalue:publicationvalue, streamdefinition:MoBlo_StreamMap[streamname]};
            
        	var publicationposition = SP_publiposition[MoBlo_ClickedItem];
        	
        	MoBlo_PublicationMap[publicationposition.id]=newpublicationdefinition;
        	SP_publiposition[MoBlo_ClickedItem].selectedIndexStream = selectedIndexStream;
        	SP_publiposition[MoBlo_ClickedItem].selectedIndexNode = selectedIndexNode;
        	
			drawStreamPublication(newpublicationdefinition, publicationposition.x, publicationposition.y, false, true);
			
		}			
		
        function addStreamPublication() {
            var selectedIndexStream = document.getElementById("listStreamName").selectedIndex;
            var streamname = document.getElementById("listStreamName").options[selectedIndexStream].value;

            var selectedIndexNode = document.getElementById("listNodeStreamPublicationName").selectedIndex;
            var nodename = document.getElementById("listNodeStreamPublicationName").options[selectedIndexNode].value;

            var publicationname = document.getElementById("streampulicationname").value;
            var publicationkey = document.getElementById("streamkey").value;
            var publicationvalue = document.getElementById("streamvalue").value;

            if (streamname != null && streamname != "" && nodename != null && nodename != ""
                    && publicationkey != null && publicationkey != "" && publicationvalue != null && publicationvalue != "") {

                var publicationdefinition = {streamname:streamname, nodename:nodename, publicationname:publicationname, publicationkey:publicationkey, publicationvalue:publicationvalue, streamdefinition:MoBlo_StreamMap[streamname]};

                var id = new Date();
                MoBlo_PublicationMap[id]=publicationdefinition;
                

                //add graphic zone
                var canvas_SP = document.querySelector('.mobloStreamPublication');
                var height = canvas_SP.height;
                var imgData= ctx_SP.getImageData(0,0,canvas_SP.width,canvas_SP.height);
                canvas_SP.height = height + 160;
                ctx_SP.putImageData(imgData,0,0);

                var line = Object.keys(MoBlo_PublicationMap).length;
                drawMoBloDoubleZone(ctx_SP, 5 + line * 160);
                drawStreamPublication(publicationdefinition, 5, 5 + line * 160, false, false);
				SP_publiposition.push({limit: { xmin: 10, ymin: 10 + line * 160, xmax: 1010, ymax: 10 + line * 160 + 140}, x: 5, y: 5 + line * 160, selectedIndexStream:selectedIndexStream, selectedIndexNode:selectedIndexNode, id:id});
            }
            document.getElementById("streampulicationname").value = "";
            document.getElementById("streamkey").value = "";
            document.getElementById("streamvalue").value = "";
        }

		/**************************************************************
		***************************************************************
		**************** Business Transaction *************************
		***************************************************************
		**************************************************************/
        function BusinessTransaction(transactiondefinition, x, y, selected, click) {
			var color = '';
			if (selected) {
				color = 'rgb(128, 128, 128)';
			} else {
				color = 'rgb(0, 0, 0)';
			}
			
            ctx_BT.fillStyle = 'rgb(255, 255, 255)';
            ctx_BT.fillRect(x+5, y+5, 1010, 55);
			
            var radiusArrow = 20;
			
			if (click) {
				ctx_BT.beginPath();
				ctx_BT.strokeStyle = 'rgb(153, 217, 234)';
				ctx_BT.lineWidth = 10;
				ctx_BT.moveTo(x + 10 + 100 + 5,     y + 40);
				ctx_BT.lineTo(1020 - 5 - 105 - 10, y + 40);
				ctx_BT.moveTo(1020 - 5 - 105 - 10 - 1.33 * radiusArrow,     y + 40 - 0.66 * radiusArrow);
				ctx_BT.lineTo(1020 - 5 - 105 - 10, y + 40);
				ctx_BT.moveTo(1020 - 5 - 105 - 10 - 1.33 * radiusArrow,     y + 40 + 0.66 * radiusArrow);
				ctx_BT.lineTo(1020 - 5 - 105 - 10, y + 40);
				ctx_BT.stroke();
				
				ctx_BT.fillStyle = 'rgb(153, 217, 234)';
				ctx_BT.fillRect(x + 115, y+5, 760 - x, 25);
			}
			
            //Origin name
            ctx_BT.fillStyle = color;
            ctx_BT.font = '18px serif';
            ctx_BT.textAlign = "right";
            ctx_BT.fillText(transactiondefinition.originname, x + 105, y + 45);
            ctx_BT.textAlign = "left";

            //Destination name
            ctx_BT.fillStyle = color;
            ctx_BT.font = '18px serif';
            ctx_BT.fillText(transactiondefinition.destinationname, 1020 - 5 - 105, y + 45);

            //Arrow
            ctx_BT.beginPath();
            ctx_BT.lineWidth = 4;
            if (!transactiondefinition.BCTransactionTrue) {
                ctx_BT.setLineDash([10, 10]);
            }
            ctx_BT.strokeStyle = color;
            ctx_BT.moveTo(x + 10 + 100 + 5,     y + 40);
            ctx_BT.lineTo(1020 - 5 - 105 - 10, y + 40);
            ctx_BT.moveTo(1020 - 5 - 105 - 10 - 1.33 * radiusArrow,     y + 40 - 0.66 * radiusArrow);
            ctx_BT.lineTo(1020 - 5 - 105 - 10, y + 40);
            ctx_BT.moveTo(1020 - 5 - 105 - 10 - 1.33 * radiusArrow,     y + 40 + 0.66 * radiusArrow);
            ctx_BT.lineTo(1020 - 5 - 105 - 10, y + 40);
            ctx_BT.stroke();
            ctx_BT.setLineDash([1, 0]);

            //Publication values
            ctx_BT.fillStyle = color;
            ctx_BT.font = '18px serif';
            ctx_BT.textAlign = "center";
            var center = Math.trunc((x + 10 + 100 + 5)+(1020 - 5 - 105 - 10 - (x + 10 + 100 + 5))/2);
            var trans_text = '#t { ' + transactiondefinition.assetvalue + ' ' + transactiondefinition.assetname;
            if (transactiondefinition.transactiondata != null && transactiondefinition.transactiondata != "") {
                trans_text = trans_text + ' [ ' + transactiondefinition.transactiondata + ' ]'
            }
            ctx_BT.fillText( trans_text + ' }', center, y + 25);
            ctx_BT.textAlign = "left";
        }


		function manageBusinessTransaction() {
			if (MoBlo_ClickedItem >= 0) {
				modifyBusinessTransaction();
			} else {
				addBusinessTransaction();
			}
		}
		
        function modifyBusinessTransaction() {
            var selectedIndexOrigin = document.getElementById("listOriginNodeName").selectedIndex;
            var originname = document.getElementById("listOriginNodeName").options[selectedIndexOrigin].value;

            var selectedIndexDestination = document.getElementById("listDestinationNodeName").selectedIndex;
            var destinationname = document.getElementById("listDestinationNodeName").options[selectedIndexDestination].value;

            var selectedIndexAssetName = document.getElementById("listAssetName").selectedIndex;
            var assetname = "";
            if (selectedIndexAssetName >= 0) {
                assetname = document.getElementById("listAssetName").options[selectedIndexAssetName].value;
            }

            var actionname = document.getElementById("actionname").value;
            var assetvalue = document.getElementById("assetvalue").value;
            var transactiondata = document.getElementById("transactiondata").value;
            
			if (selectedIndexAssetName == 0) {
				assetvalue = "";
			}
			
            var BCTransactionTrue = document.getElementById('BCTransactionTrue').checked;
			
			var newtransactiondefinition = {originname:originname, destinationname:destinationname, assetname:assetname, assetvalue:assetvalue, transactiondata:transactiondata, actionname:actionname, BCTransactionTrue:BCTransactionTrue};
			
			var transactionposition = BT_transacposition[MoBlo_ClickedItem];
			
        	MoBlo_TransactionDefinitionMap[transactionposition.id]=newtransactiondefinition;
        	BT_transacposition[MoBlo_ClickedItem].selectedIndexOrigin = selectedIndexOrigin;
        	BT_transacposition[MoBlo_ClickedItem].selectedIndexDestination = selectedIndexDestination;
        	BT_transacposition[MoBlo_ClickedItem].selectedIndexAssetName = selectedIndexAssetName;

			BusinessTransaction(newtransactiondefinition, transactionposition.x, transactionposition.y, false, true);
		}		


        function addBusinessTransaction() {
            var selectedIndexOrigin = document.getElementById("listOriginNodeName").selectedIndex;
            var originname = document.getElementById("listOriginNodeName").options[selectedIndexOrigin].value;

            var selectedIndexDestination = document.getElementById("listDestinationNodeName").selectedIndex;
            var destinationname = document.getElementById("listDestinationNodeName").options[selectedIndexDestination].value;

            var selectedIndexAssetName = document.getElementById("listAssetName").selectedIndex;
            var assetname = "";
            if (selectedIndexAssetName >= 0) {
                assetname = document.getElementById("listAssetName").options[selectedIndexAssetName].value;
            }

            var actionname = document.getElementById("actionname").value;
            var assetvalue = document.getElementById("assetvalue").value;
            var transactiondata = document.getElementById("transactiondata").value;

            if (originname != null && originname != "" && destinationname != null && destinationname != "") {

				if (selectedIndexAssetName == 0) {
					assetvalue = "";
				}

                var BCTransactionTrue = document.getElementById('BCTransactionTrue').checked;
                var transactiondefinition = {originname:originname, destinationname:destinationname, assetname:assetname, assetvalue:assetvalue, transactiondata:transactiondata, actionname:actionname, BCTransactionTrue:BCTransactionTrue};

                var id = new Date();
                MoBlo_TransactionDefinitionMap[id]=transactiondefinition;

                var actionindex = -1;
                if (actionname != null && actionname != "") {
                    actionindex = MoBlo_ActionNameList.indexOf(actionname);
                }
                var nbactions = MoBlo_ActionNameList.length;
                if (actionindex == -1) {
                    MoBlo_ActionNameList.push(actionname);
                }

                var nbtransac = Object.keys(MoBlo_TransactionDefinitionMap).length; - 1;

                var yZone = 150 + nbactions * 50 + nbtransac * 60;
                //add graphic zone
                var canvas_BT = document.querySelector('.mobloBusinessTransactions');
                var imgData= ctx_BT.getImageData(0,0,canvas_BT.width,canvas_BT.height);

                canvas_BT.height = yZone + 60;
                if (actionindex == -1) {
                    canvas_BT.height = canvas_BT.height + 50;
                }
                ctx_BT.putImageData(imgData,0,0);

                if (actionindex == -1) {
                    //need to close the previous opened zone and to open a new opened zone
                    if (MoBlo_ActionNameList.length == 1) {
                        drawMoBloDoubleOpenedZone(ctx_BT, yZone, MoBlo_ActionNameList.length);
                    } else {
                        drawMoBloDoubleOpenedZone(ctx_BT, yZone + 2, MoBlo_ActionNameList.length);
                    }

                    //Action name
                    ctx_BT.fillStyle = 'rgb(0, 102, 160)';
                    ctx_BT.font = '18px serif';
                    ctx_BT.fillText("Action : " + actionname, 15, yZone + 40);

                    yZone = yZone + 50;
                }
				
                BusinessTransaction(transactiondefinition, 5, yZone, false, false);
				BT_transacposition.push({limit: { xmin: 10, ymin: yZone+5, xmax: 1010, ymax: yZone+50}, x: 5, y: yZone, id: id, selectedIndexOrigin:selectedIndexOrigin, selectedIndexDestination:selectedIndexDestination, selectedIndexAssetName:selectedIndexAssetName});
            }
            
            document.getElementById("assetvalue").value = "";
            document.getElementById("transactiondata").value = "";
			document.getElementById('BCTransactionTrue').checked = true;
			document.getElementById('BCTransactionFalse').checked = false;
            
        }

		/**************************************************************
		***************************************************************
		******************** Interactions *****************************
		***************************************************************
		**************************************************************/

		function getMousePos(canvas, evt) {
			var rect = canvas.getBoundingClientRect();
			return {
				x: evt.clientX - rect.left,
				y: evt.clientY - rect.top
			};
		}
		
		function selectzone() {
			var positionlist = [];
			if (MoBlo_ActiveDiagramme == 'PM' ) {
				positionlist = PM_nodeposition;
			} else if (MoBlo_ActiveDiagramme == 'UD' ) {
				positionlist = UD_unitposition;
			} else if (MoBlo_ActiveDiagramme == 'BT' ) {
				positionlist = BT_transacposition;
			} else if (MoBlo_ActiveDiagramme == 'SD' ) {
				positionlist = SD_streamposition;
			} else if (MoBlo_ActiveDiagramme == 'SP' ) {
				positionlist = SP_publiposition;
			}
			
			var selectedzone = -1;
			for (var i = 0; i < positionlist.length; i++) {
				var zonelimits = positionlist[i].limit;
				if (MoBlo_MousePosition.x >= zonelimits.xmin && MoBlo_MousePosition.y >= zonelimits.ymin && 
						MoBlo_MousePosition.x <= zonelimits.xmax && MoBlo_MousePosition.y <= zonelimits.ymax ) {
					//in zone
					selectedzone = i;
				}
			}
			
			if (MoBlo_SelectedItem != selectedzone) {
				if (MoBlo_ActiveDiagramme == 'PM' ) {
					var clicked = false;
					
					if (MoBlo_SelectedItem >= 0) {
						if (MoBlo_SelectedItem == MoBlo_ClickedItem) {
							clicked = true;
						}

						var rights = getPMNoderights(positionlist[MoBlo_SelectedItem].nodename, positionlist[MoBlo_SelectedItem].rightsindex, positionlist[MoBlo_SelectedItem].rightsname);
						
						if (rights.name == 'user') {
							drawBizNode(rights, positionlist[MoBlo_SelectedItem].x, positionlist[MoBlo_SelectedItem].y, positionlist[MoBlo_SelectedItem].radius, false, clicked);
						} else if (rights.name == 'control') {
							drawConnectNode(positionlist[MoBlo_SelectedItem].x, positionlist[MoBlo_SelectedItem].y, positionlist[MoBlo_SelectedItem].radius, false, clicked);
						} else if (rights.name == 'admin') {
							drawAdminNode(rights, positionlist[MoBlo_SelectedItem].x, positionlist[MoBlo_SelectedItem].y, positionlist[MoBlo_SelectedItem].radius, false, clicked);
						}
					}
					if (selectedzone >= 0) {
						if (selectedzone == MoBlo_ClickedItem) {
							clicked = true;
						}
						
						var rights = getPMNoderights(positionlist[selectedzone].nodename, positionlist[selectedzone].rightsindex, positionlist[selectedzone].rightsname);
						
						if (rights.name == 'user') {
							drawBizNode(rights, positionlist[selectedzone].x, positionlist[selectedzone].y, positionlist[selectedzone].radius, true, clicked);
						} else if (rights.name == 'control') {
							drawConnectNode(positionlist[selectedzone].x, positionlist[selectedzone].y, positionlist[selectedzone].radius, true, clicked);
						} else if (rights.name == 'admin') {
							drawAdminNode(rights, positionlist[selectedzone].x, positionlist[selectedzone].y, positionlist[selectedzone].radius, true, clicked);
						}
					}
				} else if (MoBlo_ActiveDiagramme == 'UD' ) {
					var clicked = false;
					
					if (MoBlo_SelectedItem >= 0) {
						if (MoBlo_SelectedItem == MoBlo_ClickedItem) {
							clicked = true;
						}
						var unitdefinition = MoBlo_UnitMap[positionlist[MoBlo_SelectedItem].unitname];
						
						drawUnitDefinition(unitdefinition, positionlist[MoBlo_SelectedItem].x, positionlist[MoBlo_SelectedItem].y, positionlist[MoBlo_SelectedItem].radius, false, clicked);
					}
					if (selectedzone >= 0) {
						if (selectedzone == MoBlo_ClickedItem) {
							clicked = true;
						}
						var unitdefinition = MoBlo_UnitMap[positionlist[selectedzone].unitname];
						
						drawUnitDefinition(unitdefinition, positionlist[selectedzone].x, positionlist[selectedzone].y, positionlist[selectedzone].radius, true, clicked);
					} 
				} else if (MoBlo_ActiveDiagramme == 'BT' ) {
					var clicked = false;
					
					if (MoBlo_SelectedItem >= 0) {
						if (MoBlo_SelectedItem == MoBlo_ClickedItem) {
							clicked = true;
						}
						var transactiondefinition = MoBlo_TransactionDefinitionMap[positionlist[MoBlo_SelectedItem].id];
						BusinessTransaction(transactiondefinition, positionlist[MoBlo_SelectedItem].x, positionlist[MoBlo_SelectedItem].y, false, clicked);
					}
					if (selectedzone >= 0) {
						if (selectedzone == MoBlo_ClickedItem) {
							clicked = true;
						}
						var transactiondefinition = MoBlo_TransactionDefinitionMap[positionlist[selectedzone].id];
						BusinessTransaction(transactiondefinition, positionlist[selectedzone].x, positionlist[selectedzone].y, true, clicked);
						
					}
				} else if (MoBlo_ActiveDiagramme == 'SD' ) {
					var clicked = false;
					
					if (MoBlo_SelectedItem >= 0) {
						if (MoBlo_SelectedItem == MoBlo_ClickedItem) {
							clicked = true;
						}
						drawStreamDefinition(positionlist[MoBlo_SelectedItem].streamdefinition, positionlist[MoBlo_SelectedItem].x, positionlist[MoBlo_SelectedItem].y, false, clicked);
					}
					if (selectedzone >= 0) {
						if (selectedzone == MoBlo_ClickedItem) {
							clicked = true;
						}
						drawStreamDefinition(positionlist[selectedzone].streamdefinition, positionlist[selectedzone].x, positionlist[selectedzone].y, true, clicked);
						
					}
				} else if (MoBlo_ActiveDiagramme == 'SP' ) {
					var clicked = false;
					
					if (MoBlo_SelectedItem >= 0) {
						if (MoBlo_SelectedItem == MoBlo_ClickedItem) {
							clicked = true;
						}
						var publicationdefinition = MoBlo_PublicationMap[positionlist[MoBlo_SelectedItem].id];
						drawStreamPublication(publicationdefinition, positionlist[MoBlo_SelectedItem].x, positionlist[MoBlo_SelectedItem].y, false, clicked);
					}
					if (selectedzone >= 0) {
						if (selectedzone == MoBlo_ClickedItem) {
							clicked = true;
						}
						var publicationdefinition = MoBlo_PublicationMap[positionlist[selectedzone].id];
						
						drawStreamPublication(publicationdefinition, positionlist[selectedzone].x, positionlist[selectedzone].y, true, clicked);
					}
				}

				MoBlo_SelectedItem = selectedzone;
			}
			
		}
		
		function clickzone() {
			var previousclick = MoBlo_ClickedItem;
			if (MoBlo_ClickedItem != MoBlo_SelectedItem) {
				MoBlo_ClickedItem = MoBlo_SelectedItem;
			} else {
				MoBlo_ClickedItem = -1;
			}
			var selected = false;
			if (previousclick == MoBlo_ClickedItem) {
				selected = true;
			}
			
			var positionlist = [];
			if (MoBlo_ActiveDiagramme == 'PM' ) {
				document.getElementById("PMAddAddress").innerHTML  = 'Add Address';
				positionlist = PM_nodeposition;
				
				if (previousclick >= 0) {
					var rights = getPMNoderights(positionlist[previousclick].nodename, positionlist[previousclick].rightsindex, positionlist[previousclick].rightsname);
					
					if (rights.name == 'user') {
						drawBizNode(rights, positionlist[previousclick].x, positionlist[previousclick].y, positionlist[previousclick].radius, selected, false);
					} else if (rights.name == 'control') {
						drawConnectNode(positionlist[previousclick].x, positionlist[previousclick].y, positionlist[previousclick].radius, selected, false);
					} else if (rights.name == 'admin') {
						drawAdminNode(rights, positionlist[previousclick].x, positionlist[previousclick].y, positionlist[previousclick].radius, selected, false);
					}
				}
				
				document.getElementById("listNodeName").disabled = false;
				document.getElementById('processRight').checked = false;
				document.getElementById('activateRight').checked = false;
				document.getElementById('adminRight').checked = false;
				document.getElementById('originRight').checked = false;
				document.getElementById('sendRight').checked = false;
				document.getElementById('receiveRight').checked = false;
				document.getElementById('issueRight').checked = false;
				document.getElementById('createRight').checked = false;
				document.getElementById('connectRight').checked = false;
				
				if (MoBlo_ClickedItem >= 0) {
					document.getElementById("PMAddAddress").innerHTML  = 'Modify Address';
					
					var rights = getPMNoderights(positionlist[MoBlo_ClickedItem].nodename, positionlist[MoBlo_ClickedItem].rightsindex, positionlist[MoBlo_ClickedItem].rightsname);
					
					document.getElementById("listNodeName").selectedIndex = positionlist[MoBlo_ClickedItem].selectedIndex;
					document.getElementById("listNodeName").disabled = true;
					
					if (rights.name == 'user') {
						drawBizNode(rights, positionlist[MoBlo_ClickedItem].x, positionlist[MoBlo_ClickedItem].y, positionlist[MoBlo_ClickedItem].radius, true, true);
						if (rights.send) {
							document.getElementById('sendRight').checked = true;
						}
						if (rights.receive) {
							document.getElementById('receiveRight').checked = true;
						}
						if (rights.issue) {
							document.getElementById('issueRight').checked = true;
						}
						if (rights.create) {
							document.getElementById('createRight').checked = true;
						}
						
					} else if (rights.name == 'control') {
						drawConnectNode(positionlist[MoBlo_ClickedItem].x, positionlist[MoBlo_ClickedItem].y, positionlist[MoBlo_ClickedItem].radius, true, true);
						if (rights.connect) {
							document.getElementById('connectRight').checked = true;
						}
					} else if (rights.name == 'admin') {
						drawAdminNode(rights, positionlist[MoBlo_ClickedItem].x, positionlist[MoBlo_ClickedItem].y, positionlist[MoBlo_ClickedItem].radius, true, true);
						if (rights.origin) {
							document.getElementById('originRight').checked = true;
						}
						if (rights.admin) {
							document.getElementById('adminRight').checked = true;
						}
						if (rights.activate) {
							document.getElementById('activateRight').checked = true;
						}
						if (rights.process) {
							document.getElementById('processRight').checked = true;
						}
					}
				}
			} else if (MoBlo_ActiveDiagramme == 'UD' ) {
				document.getElementById("UDAddUnit").innerHTML  = 'Add Unit';
				positionlist = UD_unitposition;
				
				if (previousclick >= 0) {
					var unitdefinition = MoBlo_UnitMap[positionlist[previousclick].unitname];
					drawUnitDefinition(unitdefinition, positionlist[previousclick].x, positionlist[previousclick].y, positionlist[previousclick].radius, selected, false);
				}
				
				document.getElementById("listNodeIssueName").selectedIndex = 0;
				document.getElementById("unitname").value = "";
				document.getElementById("unitname").disabled = false;
				document.getElementById("unitquantity").value = "";
				document.getElementById('unitopenedTrue').checked = true;
				document.getElementById('unitopenedFalse').checked = false;
				
				if (MoBlo_ClickedItem >= 0) {
					document.getElementById("UDAddUnit").innerHTML  = 'Modify Unit';
					
					var unitdefinition = MoBlo_UnitMap[positionlist[MoBlo_ClickedItem].unitname];
				
					drawUnitDefinition(unitdefinition, positionlist[MoBlo_ClickedItem].x, positionlist[MoBlo_ClickedItem].y, positionlist[MoBlo_ClickedItem].radius, true, true);
					document.getElementById("listNodeIssueName").selectedIndex = positionlist[MoBlo_ClickedItem].nodeindex;
					document.getElementById("unitname").value = unitdefinition.unitname;
					document.getElementById("unitname").disabled = true;
					document.getElementById("unitquantity").value = unitdefinition.unitquantity;
					document.getElementById('unitopenedTrue').checked = unitdefinition.unitopenedTrue;
					document.getElementById('unitopenedFalse').checked = !unitdefinition.unitopenedTrue;
				}
			} else if (MoBlo_ActiveDiagramme == 'BT' ) {
				document.getElementById("BTAddTransaction").innerHTML  = 'Add Transaction';
				
				positionlist = BT_transacposition;
				if (previousclick >= 0) {
					var transactiondefinition = MoBlo_TransactionDefinitionMap[positionlist[previousclick].id];
					BusinessTransaction(transactiondefinition, positionlist[previousclick].x, positionlist[previousclick].y, selected, false);
				}
				
	            document.getElementById("assetvalue").value = "";
	            document.getElementById("transactiondata").value = "";
				document.getElementById("actionname").disabled = false;
				document.getElementById('BCTransactionTrue').checked = true;
				document.getElementById('BCTransactionFalse').checked = false;
	            
				
				if (MoBlo_ClickedItem >= 0) {
					document.getElementById("BTAddTransaction").innerHTML  = 'Modify Transaction';
					
					var transactiondefinition = MoBlo_TransactionDefinitionMap[positionlist[MoBlo_ClickedItem].id];
					 
					BusinessTransaction(transactiondefinition, positionlist[MoBlo_ClickedItem].x, positionlist[MoBlo_ClickedItem].y, true, true);
					
		            document.getElementById("listOriginNodeName").selectedIndex = positionlist[MoBlo_ClickedItem].selectedIndexOrigin;
		            document.getElementById("listDestinationNodeName").selectedIndex = positionlist[MoBlo_ClickedItem].selectedIndexDestination;
		            document.getElementById("listAssetName").selectedIndex = positionlist[MoBlo_ClickedItem].selectedIndexAssetName;
		            document.getElementById("actionname").value = transactiondefinition.actionname;
					document.getElementById("actionname").disabled = true;
		            document.getElementById("assetvalue").value = transactiondefinition.assetvalue;
		            document.getElementById("transactiondata").value = transactiondefinition.transactiondata;
					document.getElementById('BCTransactionTrue').checked = transactiondefinition.BCTransactionTrue;
					document.getElementById('BCTransactionFalse').checked = !transactiondefinition.BCTransactionTrue;
				}
			} else if (MoBlo_ActiveDiagramme == 'SD' ) {
				document.getElementById("SDAddStream").innerHTML  = 'Add Stream';
				positionlist = SD_streamposition;
				
				if (previousclick >= 0) {
					drawStreamDefinition(positionlist[previousclick].streamdefinition, positionlist[previousclick].x, positionlist[previousclick].y, selected, false);
				}
				
	            document.getElementById("streamname").value = "";
				document.getElementById('streamopenedTrue').checked = true;
				document.getElementById('streamopenedFalse').checked = false;
				
				if (MoBlo_ClickedItem >= 0) {
					document.getElementById("SDAddStream").innerHTML  = 'Modify Stream';

					var streamdefinition = positionlist[MoBlo_ClickedItem].streamdefinition;
					
					drawStreamDefinition(streamdefinition, positionlist[MoBlo_ClickedItem].x, positionlist[MoBlo_ClickedItem].y, true, true);
					
		            document.getElementById("listNodeStreamName").selectedIndex = positionlist[MoBlo_ClickedItem].nodeindex;
		            document.getElementById("streamname").value = streamdefinition.streamname;
					document.getElementById('streamopenedTrue').checked = streamdefinition.streamopenedTrue;
					document.getElementById('streamopenedFalse').checked = !streamdefinition.streamopenedTrue;
				}
			} else if (MoBlo_ActiveDiagramme == 'SP' ) {
				document.getElementById("SPPublishStream").innerHTML  = 'Publish in Stream';
				positionlist = SP_publiposition;
				if (previousclick >= 0) {
					var publicationdefinition = MoBlo_PublicationMap[positionlist[previousclick].id];
					drawStreamPublication(publicationdefinition, positionlist[previousclick].x, positionlist[previousclick].y, selected, false);
				}
				
	            document.getElementById("streampulicationname").value = "";
	            document.getElementById("streamkey").value = "";
	            document.getElementById("streamvalue").value = "";
				
				if (MoBlo_ClickedItem >= 0) {
					document.getElementById("SPPublishStream").innerHTML  = 'Modify Publication';

					var publicationdefinition = MoBlo_PublicationMap[positionlist[MoBlo_ClickedItem].id];
					drawStreamPublication(publicationdefinition, positionlist[MoBlo_ClickedItem].x, positionlist[MoBlo_ClickedItem].y, true, true);
					
		            document.getElementById("streampulicationname").value = publicationdefinition.publicationname;
		            document.getElementById("streamkey").value = publicationdefinition.publicationkey;
		            document.getElementById("streamvalue").value = publicationdefinition.publicationvalue;
		            document.getElementById("listStreamName").selectedIndex = positionlist[MoBlo_ClickedItem].selectedIndexStream;
		            document.getElementById("listNodeStreamPublicationName").selectedIndex = positionlist[MoBlo_ClickedItem].selectedIndexNode;
				
				}
			}
			
		}
    </script>
  </body>
</html>
